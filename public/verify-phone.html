<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phone Verification - MediCare Pro</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 450px;
      width: 100%;
      padding: 40px;
      text-align: center;
    }
    
    .logo {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    h1 {
      color: #333;
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      font-size: 14px;
      margin-bottom: 30px;
    }
    
    .step {
      display: none;
    }
    
    .step.active {
      display: block;
    }
    
    .input-group {
      margin-bottom: 20px;
      text-align: left;
    }
    
    label {
      display: block;
      color: #555;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    input[type="tel"],
    input[type="text"] {
      width: 100%;
      padding: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 10px;
    }
    
    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: #f5f5f5;
      color: #666;
      margin-top: 10px;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: #e0e0e0;
      box-shadow: none;
    }
    
    .alert {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    
    .alert-error {
      background: #fee;
      color: #c33;
      border: 1px solid #fcc;
    }
    
    .alert-success {
      background: #efe;
      color: #3c3;
      border: 1px solid #cfc;
    }
    
    .alert-info {
      background: #eef;
      color: #33c;
      border: 1px solid #ccf;
    }
    
    .phone-prefix {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .prefix {
      background: #f5f5f5;
      padding: 14px 16px;
      border: 2px solid #e0e0e0;
      border-right: none;
      border-radius: 10px 0 0 10px;
      font-size: 16px;
      color: #666;
    }
    
    .phone-prefix input {
      border-radius: 0 10px 10px 0;
      flex: 1;
    }
    
    .timer {
      color: #667eea;
      font-weight: 600;
      margin-top: 15px;
      font-size: 14px;
    }
    
    .otp-input {
      letter-spacing: 8px;
      font-size: 24px;
      text-align: center;
      font-weight: 600;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .skip-link {
      margin-top: 20px;
      font-size: 13px;
      color: #999;
    }
    
    .skip-link a {
      color: #667eea;
      text-decoration: none;
    }
    
    .skip-link a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">ðŸ“±ðŸ’Š</div>
    <h1>Phone Verification</h1>
    <p class="subtitle">Secure your account and receive medication reminders via SMS</p>
    
    <div id="alert-container"></div>
    
    <!-- Step 1: Enter Phone Number -->
    <div id="step1" class="step active">
      <div class="input-group">
        <label for="phone">Enter Your Phone Number</label>
        <div class="phone-prefix">
          <span class="prefix">+91</span>
          <input 
            type="tel" 
            id="phone" 
            placeholder="9876543210"
            maxlength="10"
            pattern="[0-9]{10}"
            required
          >
        </div>
        <small style="color: #999;">Enter 10-digit Indian mobile number</small>
      </div>
      
      <button class="btn" id="send-otp-btn" onclick="sendOTP()">
        Send OTP
      </button>
      
      <div class="skip-link">
        <a href="/">Skip for now (SMS alerts won't work)</a>
      </div>
    </div>
    
    <!-- Step 2: Enter OTP -->
    <div id="step2" class="step">
      <div class="alert alert-info">
        We've sent a 6-digit verification code to <strong id="sent-phone"></strong>
      </div>
      
      <div class="input-group">
        <label for="otp">Enter Verification Code</label>
        <input 
          type="text" 
          id="otp" 
          class="otp-input"
          placeholder="000000"
          maxlength="6"
          pattern="[0-9]{6}"
          required
        >
      </div>
      
      <div class="timer" id="timer">Code expires in <span id="countdown">05:00</span></div>
      
      <button class="btn" id="verify-otp-btn" onclick="verifyOTP()">
        Verify & Continue
      </button>
      
      <button class="btn btn-secondary" id="resend-btn" onclick="resendOTP()" disabled>
        Resend Code
      </button>
      
      <button class="btn btn-secondary" onclick="changeNumber()">
        Change Number
      </button>
    </div>
    
    <!-- Step 3: Success -->
    <div id="step3" class="step">
      <div style="font-size: 64px; margin-bottom: 20px;">âœ…</div>
      <h2 style="color: #10b981; margin-bottom: 10px;">Verified!</h2>
      <p style="color: #666; margin-bottom: 30px;">
        Your phone number has been successfully verified. You'll now receive medication reminders via SMS.
      </p>
      
      <button class="btn" onclick="window.location.href='/'">
        Continue to Dashboard
      </button>
    </div>
  </div>
  
  <script>
    let currentPhone = '';
    let countdownInterval = null;
    
    function showAlert(message, type = 'error') {
      const container = document.getElementById('alert-container');
      container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      setTimeout(() => container.innerHTML = '', 5000);
    }
    
    function showStep(stepNumber) {
      document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
      document.getElementById(`step${stepNumber}`).classList.add('active');
    }
    
    async function sendOTP() {
      const phoneInput = document.getElementById('phone');
      const phone = phoneInput.value.trim();
      
      if (!/^\d{10}$/.test(phone)) {
        showAlert('Please enter a valid 10-digit phone number');
        return;
      }
      
      const btn = document.getElementById('send-otp-btn');
      btn.disabled = true;
      btn.innerHTML = 'Sending OTP<span class="loading"></span>';
      
      try {
        const response = await fetch('/api/verify/send-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: '+91' + phone })
        });
        
        const data = await response.json();
        
        if (data.success) {
          currentPhone = '+91' + phone;
          document.getElementById('sent-phone').textContent = currentPhone;
          showStep(2);
          startCountdown();
          document.getElementById('otp').focus();
        } else {
          showAlert(data.error || 'Failed to send OTP. Please try again.');
          btn.disabled = false;
          btn.innerHTML = 'Send OTP';
        }
      } catch (error) {
        showAlert('Network error. Please check your connection and try again.');
        btn.disabled = false;
        btn.innerHTML = 'Send OTP';
      }
    }
    
    async function verifyOTP() {
      const otpInput = document.getElementById('otp');
      const otp = otpInput.value.trim();
      
      if (!/^\d{6}$/.test(otp)) {
        showAlert('Please enter a valid 6-digit code');
        return;
      }
      
      const btn = document.getElementById('verify-otp-btn');
      btn.disabled = true;
      btn.innerHTML = 'Verifying<span class="loading"></span>';
      
      try {
        const response = await fetch('/api/verify/check-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: currentPhone, otp: otp })
        });
        
        const data = await response.json();
        
        if (data.success) {
          if (countdownInterval) clearInterval(countdownInterval);
          showStep(3);
        } else {
          showAlert(data.error || 'Invalid verification code');
          btn.disabled = false;
          btn.innerHTML = 'Verify & Continue';
        }
      } catch (error) {
        showAlert('Network error. Please try again.');
        btn.disabled = false;
        btn.innerHTML = 'Verify & Continue';
      }
    }
    
    function resendOTP() {
      document.getElementById('otp').value = '';
      sendOTP();
    }
    
    function changeNumber() {
      if (countdownInterval) clearInterval(countdownInterval);
      document.getElementById('phone').value = '';
      document.getElementById('otp').value = '';
      showStep(1);
    }
    
    function startCountdown() {
      let timeLeft = 300; // 5 minutes
      const resendBtn = document.getElementById('resend-btn');
      resendBtn.disabled = true;
      
      countdownInterval = setInterval(() => {
        timeLeft--;
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        document.getElementById('countdown').textContent = 
          `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
          clearInterval(countdownInterval);
          document.getElementById('timer').innerHTML = 
            '<span style="color: #f43f5e;">Code expired. Please request a new one.</span>';
          resendBtn.disabled = false;
        }
      }, 1000);
    }
    
    // Allow Enter key to submit
    document.getElementById('phone').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendOTP();
    });
    
    document.getElementById('otp').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') verifyOTP();
    });
    
    // Auto-focus OTP input after paste
    document.getElementById('otp').addEventListener('paste', (e) => {
      setTimeout(() => {
        const otp = e.target.value;
        if (/^\d{6}$/.test(otp)) {
          verifyOTP();
        }
      }, 100);
    });
  </script>
</body>
</html>
