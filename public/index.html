<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2563EB">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="description" content="Smart medication management with AI assistance, reminders, and tracking">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Medication Manager - AI Powered</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    }
    
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
    }
    
    .status-pending {
      background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
      color: #92400E;
      font-weight: 600;
    }
    
    .status-taken {
      background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
      color: #065F46;
      font-weight: 600;
    }
    
    .status-missed {
      background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
      color: #991B1B;
      font-weight: 600;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 50;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      animation: fadeIn 0.2s ease;
    }
    
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      animation: slideUp 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .severity-mild { color: #F59E0B; }
    .severity-moderate { color: #EF4444; }
    .severity-severe { color: #DC2626; font-weight: bold; }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }
    
    .stat-card {
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .nav-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      body {
        padding-bottom: 80px; /* Space for floating AI button */
      }
      
      .glass-effect {
        border-radius: 0;
      }
      
      nav .flex {
        flex-wrap: wrap;
      }
      
      nav h1 {
        font-size: 1.25rem !important;
      }
      
      nav p {
        font-size: 0.65rem !important;
      }
      
      .tab-btn {
        padding: 0.5rem 0.75rem !important;
        font-size: 0.75rem !important;
      }
      
      .tab-btn i {
        display: none; /* Hide icons on mobile to save space */
      }
      
      .card {
        border-radius: 12px;
      }
      
      .stat-card {
        padding: 1rem !important;
      }
      
      .stat-card .text-4xl {
        font-size: 2rem !important;
      }
      
      .stat-card .text-3xl {
        font-size: 1.5rem !important;
      }
      
      .btn-primary {
        width: 100%;
        justify-content: center;
      }
      
      /* Mobile Navigation - Stack vertically */
      @media (max-width: 640px) {
        nav .flex.items-center.space-x-2 {
          width: 100%;
          justify-content: space-around;
          margin-top: 0.5rem;
          gap: 0.25rem;
        }
        
        .tab-btn {
          padding: 0.4rem 0.5rem !important;
          font-size: 0.7rem !important;
        }
      }
      
      /* Modal adjustments for mobile */
      .modal > div {
        max-width: 95% !important;
        margin: 1rem !important;
        max-height: 90vh;
        overflow-y: auto;
      }
      
      /* Form adjustments */
      .grid.grid-cols-2 {
        grid-template-columns: 1fr !important;
      }
      
      /* Table responsive */
      table {
        font-size: 0.75rem;
      }
      
      table th,
      table td {
        padding: 0.5rem 0.25rem !important;
      }
    }
    
    /* Extra small devices */
    @media (max-width: 380px) {
      nav h1 {
        font-size: 1rem !important;
      }
      
      .tab-btn {
        padding: 0.3rem 0.4rem !important;
        font-size: 0.65rem !important;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="glass-effect shadow-lg sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8">
      <div class="flex flex-col sm:flex-row justify-between py-3 sm:py-0 sm:h-20">
        <div class="flex items-center space-x-2 sm:space-x-3 mb-2 sm:mb-0">
          <div class="bg-gradient-to-br from-blue-500 to-purple-600 p-2 sm:p-3 rounded-xl shadow-lg">
            <i class="fas fa-pills text-xl sm:text-2xl text-white"></i>
          </div>
          <div>
            <h1 class="text-xl sm:text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">MediCare Pro</h1>
            <p class="text-xs text-gray-500">Smart Medication Management</p>
          </div>
        </div>
        <div class="flex items-center space-x-1 sm:space-x-2 justify-center sm:justify-end">
          <button onclick="showTab('dashboard')" class="tab-btn px-3 sm:px-4 py-2 rounded-xl text-gray-600 hover:bg-white hover:shadow-md transition-all font-medium text-sm">
            <i class="fas fa-home mr-2"></i><span>Dashboard</span>
          </button>
          <button onclick="showTab('medications')" class="tab-btn px-3 sm:px-4 py-2 rounded-xl text-gray-600 hover:bg-white hover:shadow-md transition-all font-medium text-sm">
            <i class="fas fa-pills mr-2"></i><span>Meds</span>
          </button>
          <button onclick="showTab('schedules')" class="tab-btn px-3 sm:px-4 py-2 rounded-xl text-gray-600 hover:bg-white hover:shadow-md transition-all font-medium text-sm">
            <i class="fas fa-clock mr-2"></i><span>Schedule</span>
          </button>
          <button onclick="showTab('history')" class="tab-btn px-3 sm:px-4 py-2 rounded-xl text-gray-600 hover:bg-white hover:shadow-md transition-all font-medium text-sm">
            <i class="fas fa-history mr-2"></i><span>History</span>
          </button>
          <button onclick="showTab('stats')" class="tab-btn px-3 sm:px-4 py-2 rounded-xl text-gray-600 hover:bg-white hover:shadow-md transition-all font-medium text-sm">
            <i class="fas fa-chart-line mr-2"></i><span>Stats</span>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-8 py-4 sm:py-8 mt-2 sm:mt-4">
    <!-- Dashboard Tab -->
    <div id="dashboard-tab" class="tab-content">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Quick Stats -->
        <div class="card stat-card p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500 mb-1">Active Medications</p>
              <p class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-blue-400 bg-clip-text text-transparent" id="stat-active-meds">0</p>
            </div>
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-4 rounded-2xl shadow-lg">
              <i class="fas fa-pills text-3xl text-white"></i>
            </div>
          </div>
        </div>
        
        <div class="card stat-card p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500 mb-1">Today's Doses</p>
              <p class="text-4xl font-bold bg-gradient-to-r from-green-600 to-green-400 bg-clip-text text-transparent" id="stat-today-doses">0</p>
            </div>
            <div class="bg-gradient-to-br from-green-500 to-green-600 p-4 rounded-2xl shadow-lg">
              <i class="fas fa-calendar-day text-3xl text-white"></i>
            </div>
          </div>
        </div>
        
        <div class="card stat-card p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500 mb-1">Adherence Rate</p>
              <p class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-purple-400 bg-clip-text text-transparent" id="stat-adherence">0%</p>
            </div>
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-4 rounded-2xl shadow-lg">
              <i class="fas fa-chart-line text-3xl text-white"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Refill Alerts -->
      <div class="card p-6 mb-8" id="refill-alerts">
        <div class="flex items-center mb-4">
          <div class="bg-gradient-to-br from-orange-500 to-orange-600 p-3 rounded-xl mr-3">
            <i class="fas fa-exclamation-triangle text-white text-xl"></i>
          </div>
          <h2 class="text-2xl font-bold text-gray-800">Refill Alerts</h2>
        </div>
        <div id="refill-list"></div>
      </div>

      <!-- Today's Schedule -->
      <div class="card p-6">
        <div class="flex justify-between items-center mb-4">
          <div class="flex items-center">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-3 rounded-xl mr-3">
              <i class="fas fa-calendar-check text-white text-xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800">Today's Schedule</h2>
          </div>
          <button onclick="loadTodaySchedule()" class="bg-blue-100 text-blue-600 p-3 rounded-xl hover:bg-blue-200 transition-all">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
        <div id="today-schedule"></div>
      </div>
    </div>

    <!-- Medications Tab -->
    <div id="medications-tab" class="tab-content hidden">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 sm:mb-6 gap-3">
        <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Medications</h2>
        <button onclick="showAddMedicationModal()" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold shadow-lg w-full sm:w-auto">
          <i class="fas fa-plus mr-2"></i>Add Medication
        </button>
      </div>
      
      <div class="mb-4">
        <input type="text" id="search-meds" placeholder="Search medications..." 
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
          onkeyup="searchMedications()">
      </div>
      
      <div id="medications-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

    <!-- Schedules Tab -->
    <div id="schedules-tab" class="tab-content hidden">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 sm:mb-6 gap-3">
        <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Medication Schedules</h2>
        <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
          <select id="schedule-sort" onchange="loadSchedules()" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
            <option value="time">Sort by Time</option>
            <option value="medication">Sort by Medication</option>
            <option value="frequency">Sort by Frequency</option>
          </select>
          <label class="flex items-center px-4 py-2 bg-gray-100 rounded-lg cursor-pointer">
            <input type="checkbox" id="schedule-group" onchange="loadSchedules()" class="mr-2">
            <span class="text-sm font-medium text-gray-700">Group by Time</span>
          </label>
          <button onclick="showAddScheduleModal()" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold shadow-lg">
            <i class="fas fa-plus mr-2"></i>Add Schedule
          </button>
        </div>
      </div>
      <div id="schedules-list"></div>
    </div>

    <!-- History Tab -->
    <div id="history-tab" class="tab-content hidden">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Medication History</h2>
      <div class="bg-white rounded-lg shadow-sm p-6">
        <div id="history-list"></div>
      </div>
    </div>

    <!-- Stats Tab -->
    <div id="stats-tab" class="tab-content hidden">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Adherence Statistics</h2>
      <div class="bg-white rounded-lg shadow-sm p-6">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Period</label>
          <select id="stats-period" onchange="loadAdherenceStats()" class="px-4 py-2 border rounded-lg">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
          </select>
        </div>
        <div id="stats-list"></div>
      </div>
    </div>
  </div>

  <!-- Add Medication Modal -->
  <div id="add-medication-modal" class="modal">
    <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
      <h2 class="text-2xl font-bold mb-6">Add New Medication</h2>
      <form id="medication-form" onsubmit="addMedication(event)">
        <div class="grid grid-cols-2 gap-4">
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Medication Name *</label>
            <input type="text" id="med-name" name="name" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Dosage *</label>
            <input type="text" id="med-dosage" name="dosage" required placeholder="e.g., 500mg" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Form *</label>
            <select id="med-form" name="form" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="">Select form</option>
              <option value="tablet">Tablet</option>
              <option value="capsule">Capsule</option>
              <option value="syrup">Syrup</option>
              <option value="injection">Injection</option>
              <option value="drops">Drops</option>
              <option value="cream">Cream</option>
              <option value="inhaler">Inhaler</option>
            </select>
          </div>
          
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Purpose</label>
            <input type="text" id="med-purpose" name="purpose" placeholder="What is this for?" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Prescribing Doctor</label>
            <input type="text" id="med-doctor" name="prescribing_doctor" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Prescription Date</label>
            <input type="date" id="med-prescription-date" name="prescription_date" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Total Quantity</label>
            <input type="number" id="med-quantity" name="total_quantity" placeholder="e.g., 30 (optional)" min="1" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Side Effects</label>
            <textarea id="med-side-effects" name="side_effects" rows="2" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
          
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
            <textarea id="med-notes" name="notes" rows="2" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
          
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">📸 Photo (Optional)</label>
            <input type="file" name="photo" accept="image/*" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
            <p class="text-xs text-gray-500 mt-1">Upload a photo of the medication (max 5MB)</p>
          </div>
        </div>
        
        <div class="flex justify-end space-x-4 mt-6">
          <button type="button" onclick="closeModal('add-medication-modal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Medication</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Schedule Modal -->
  <div id="add-schedule-modal" class="modal">
    <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4">
      <h3 class="text-2xl font-bold mb-6">Add Schedule</h3>
      <form id="add-schedule-form" onsubmit="addSchedule(event)">
        <div class="grid grid-cols-2 gap-4">
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Medication *</label>
            <select name="medication_id" id="schedule-medication-select" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="">Select medication</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Time *</label>
            <input type="time" name="time" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Frequency *</label>
            <select name="frequency" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="as_needed">As Needed</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Start Date *</label>
            <input type="date" name="start_date" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
            <input type="date" name="end_date" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Days of Week (for weekly)</label>
            <input type="text" name="days_of_week" placeholder="e.g., Mon,Wed,Fri" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Food Timing *</label>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="radio" name="food_timing" value="none" required class="mr-2">
                <span class="text-sm text-gray-700">No specific timing</span>
              </label>
              <label class="flex items-center">
                <input type="radio" name="food_timing" value="before_food" required class="mr-2">
                <span class="text-sm text-gray-700">Before food</span>
              </label>
              <label class="flex items-center">
                <input type="radio" name="food_timing" value="after_food" required class="mr-2">
                <span class="text-sm text-gray-700">After food</span>
              </label>
            </div>
          </div>
          
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Special Instructions</label>
            <textarea name="special_instructions" rows="2" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
        </div>
        
        <div class="flex justify-end space-x-4 mt-6">
          <button type="button" onclick="closeModal('add-schedule-modal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Schedule</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Schedule Modal -->
  <div id="edit-schedule-modal" class="modal">
    <div class="bg-white rounded-lg p-6 md:p-8 max-w-2xl w-full mx-4">
      <h3 class="text-xl md:text-2xl font-bold mb-6">Edit Schedule</h3>
      <form id="edit-schedule-form" onsubmit="updateSchedule(event)">
        <input type="hidden" id="edit-schedule-id" name="schedule_id">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="col-span-1 md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Medication</label>
            <select id="edit-medication-select" name="medication_id" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="">Select medication...</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Time</label>
            <input type="time" name="time" id="edit-schedule-time" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Frequency</label>
            <select name="frequency" id="edit-schedule-frequency" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="as_needed">As Needed</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
            <input type="date" name="start_date" id="edit-schedule-start" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">End Date (Optional)</label>
            <input type="date" name="end_date" id="edit-schedule-end" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          
          <div class="col-span-1 md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Food Timing *</label>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="radio" name="food_timing" value="none" id="edit-schedule-food-none" required class="mr-2">
                <span class="text-sm text-gray-700">No specific timing</span>
              </label>
              <label class="flex items-center">
                <input type="radio" name="food_timing" value="before_food" id="edit-schedule-food-before" required class="mr-2">
                <span class="text-sm text-gray-700">Before food</span>
              </label>
              <label class="flex items-center">
                <input type="radio" name="food_timing" value="after_food" id="edit-schedule-food-after" required class="mr-2">
                <span class="text-sm text-gray-700">After food</span>
              </label>
            </div>
          </div>
          
          <div class="col-span-1 md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Special Instructions</label>
            <textarea name="special_instructions" id="edit-schedule-instructions" rows="2" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
        </div>
        
        <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4 mt-6">
          <button type="button" onclick="closeModal('edit-schedule-modal')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update Schedule</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ==================== INLINE AI CHATBOT (NO CACHING) ==================== -->
  <!-- Chatbot Button - Always Visible, Embedded Directly -->
  <button id="ai-chat-toggle" style="position: fixed; bottom: 24px; right: 24px; z-index: 999999; width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, #7c3aed 0%, #2563eb 100%); border: none; cursor: pointer; box-shadow: 0 10px 30px rgba(124, 58, 237, 0.5); display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
    <svg style="width: 32px; height: 32px; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
    </svg>
    <span style="position: absolute; top: -2px; right: -2px; background: #ef4444; color: white; font-size: 11px; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-weight: bold;">AI</span>
  </button>

  <!-- Chatbot Sidebar -->
  <div id="ai-chat-sidebar" style="position: fixed; top: 0; right: 0; bottom: 0; width: 100%; max-width: 450px; background: white; box-shadow: -5px 0 30px rgba(0,0,0,0.3); transform: translateX(100%); transition: transform 0.3s ease; z-index: 999998; display: flex; flex-direction: column;">
    <!-- Header -->
    <div style="background: linear-gradient(135deg, #7c3aed 0%, #2563eb 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
          <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
          </svg>
        </div>
        <div>
          <h3 style="margin: 0; font-size: 18px; font-weight: bold;">AI Health Assistant</h3>
          <p style="margin: 0; font-size: 12px; opacity: 0.9;">Powered by Groq</p>
        </div>
      </div>
      <button id="ai-chat-close" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
        <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Messages -->
    <div id="ai-chat-messages" style="flex: 1; overflow-y: auto; padding: 20px; background: linear-gradient(to bottom, #f9fafb, #ffffff);"></div>

    <!-- Input -->
    <div style="padding: 16px; border-top: 1px solid #e5e7eb; background: white;">
      <div style="display: flex; gap: 8px; margin-bottom: 12px;">
        <input id="ai-chat-input" type="text" placeholder="Ask me anything..." style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 14px; outline: none;">
        <button id="ai-chat-send" style="background: linear-gradient(135deg, #7c3aed 0%, #2563eb 100%); color: white; border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: 600;">
          <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
          </svg>
        </button>
      </div>
      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        <button class="quick-btn" data-action="today" style="background: #dbeafe; color: #1e40af; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;">📅 Today</button>
        <button class="quick-btn" data-action="add" style="background: #dcfce7; color: #166534; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;">➕ Add</button>
        <button class="quick-btn" data-action="stats" style="background: #f3e8ff; color: #6b21a8; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;">📊 Stats</button>
      </div>
    </div>
  </div>

  <script src="app.js?v=2"></script>
  
  <!-- ==================== INLINE AI CHATBOT LOGIC (NO EXTERNAL FILES) ==================== -->
  <script>
  console.log('🤖 AI Chatbot initializing (inline, no cache)...');
  
  (function() {
    const API_BASE = window.location.hostname === 'localhost' 
      ? `http://localhost:${window.location.port || 8080}/api` 
      : '/api';
    
    let chatHistory = [];
    let isProcessing = false;
    let lastAddedMedication = null; // Track last added medication for context
    
    // DOM elements
    const toggleBtn = document.getElementById('ai-chat-toggle');
    const sidebar = document.getElementById('ai-chat-sidebar');
    const closeBtn = document.getElementById('ai-chat-close');
    const sendBtn = document.getElementById('ai-chat-send');
    const input = document.getElementById('ai-chat-input');
    const messagesDiv = document.getElementById('ai-chat-messages');
    
    console.log('✅ AI Chatbot elements found:', {
      toggleBtn: !!toggleBtn,
      sidebar: !!sidebar,
      closeBtn: !!closeBtn,
      sendBtn: !!sendBtn,
      input: !!input,
      messagesDiv: !!messagesDiv
    });
    
    // Add welcome message
    addMessage('👋 Hi! I\'m your AI medication assistant powered by Groq. I can help you:\n\n• Add medications naturally\n• Create schedules\n• Check your plan\n• View statistics\n\nTry: "Add aspirin 500mg for headaches"', 'bot');
    
    // Event listeners
    toggleBtn.addEventListener('click', () => {
      sidebar.style.transform = 'translateX(0)';
      input.focus();
    });
    
    closeBtn.addEventListener('click', () => {
      sidebar.style.transform = 'translateX(100%)';
    });
    
    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !isProcessing) sendMessage();
    });
    
    // Quick actions
    document.querySelectorAll('.quick-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const action = btn.dataset.action;
        if (action === 'today') await showTodaySchedule();
        else if (action === 'add') addMessage('What medication would you like to add? Tell me naturally, like: "Add aspirin 500mg tablet for headaches"', 'bot');
        else if (action === 'stats') await showStats();
      });
    });
    
    // Hover effect
    toggleBtn.addEventListener('mouseenter', () => {
      toggleBtn.style.transform = 'scale(1.1)';
      toggleBtn.style.boxShadow = '0 15px 40px rgba(124, 58, 237, 0.6)';
    });
    toggleBtn.addEventListener('mouseleave', () => {
      toggleBtn.style.transform = 'scale(1)';
      toggleBtn.style.boxShadow = '0 10px 30px rgba(124, 58, 237, 0.5)';
    });
    
    async function sendMessage() {
      let message = input.value.trim();
      if (!message || isProcessing) return;
      
      // If user says "schedule it" and we have last medication, replace "it" with medication name
      if (lastAddedMedication && 
          (message.toLowerCase().includes('schedule it') || 
           message.toLowerCase().includes('schedule the medication'))) {
        message = message.replace(/\bit\b/gi, lastAddedMedication.name);
        message = message.replace(/the medication/gi, lastAddedMedication.name);
        console.log('💡 Replaced "it" with medication name:', message);
      }
      
      addMessage(input.value.trim(), 'user'); // Show original message
      input.value = '';
      isProcessing = true;
      sendBtn.disabled = true;
      
      const typingId = addTypingIndicator();
      
      try {
        const response = await fetch(`${API_BASE}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, history: chatHistory.slice(-10) })
        });
        
        removeTypingIndicator(typingId);
        
        if (response.ok) {
          const data = await response.json();
          addMessage(data.response, 'bot');
          chatHistory.push(
            { role: 'user', content: message },
            { role: 'assistant', content: data.response }
          );
          
          // Handle action if AI detected intent
          if (data.action) {
            console.log('🎯 Action detected:', data.action);
            await handleAction(data.action);
          } else if (lastAddedMedication && 
                     (message.toLowerCase().includes('schedule') && 
                      message.toLowerCase().includes(lastAddedMedication.name.toLowerCase()))) {
            // Manual fallback if server didn't detect action but we have context
            console.log('💡 No action from server, attempting manual schedule...');
            const scheduleData = extractScheduleDataManually(message);
            if (scheduleData) {
              await handleAction({ type: 'add_schedule', data: scheduleData });
            }
          }
        } else {
          const error = await response.json().catch(() => ({}));
          addMessage(error.response || 'Sorry, I encountered an error. Please check that Groq API is configured.', 'bot', true);
        }
      } catch (error) {
        removeTypingIndicator(typingId);
        addMessage('Connection error. Please try again.', 'bot', true);
        console.error('Chat error:', error);
      } finally {
        isProcessing = false;
        sendBtn.disabled = false;
      }
    }
    
    function addMessage(text, sender, isError = false) {
      const div = document.createElement('div');
      div.style.marginBottom = '16px';
      div.style.display = 'flex';
      div.style.flexDirection = sender === 'user' ? 'row-reverse' : 'row';
      div.style.gap = '8px';
      
      const bubble = document.createElement('div');
      bubble.style.padding = '12px 16px';
      bubble.style.borderRadius = '16px';
      bubble.style.maxWidth = '80%';
      bubble.style.fontSize = '14px';
      bubble.style.lineHeight = '1.5';
      bubble.style.whiteSpace = 'pre-line';
      
      if (sender === 'user') {
        bubble.style.background = 'linear-gradient(135deg, #7c3aed 0%, #2563eb 100%)';
        bubble.style.color = 'white';
        bubble.style.marginLeft = 'auto';
      } else {
        bubble.style.background = isError ? '#fee2e2' : '#f3f4f6';
        bubble.style.color = isError ? '#991b1b' : '#111827';
        bubble.style.border = isError ? '1px solid #fecaca' : 'none';
      }
      
      bubble.textContent = text;
      div.appendChild(bubble);
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      return div;
    }
    
    function addTypingIndicator() {
      const div = document.createElement('div');
      div.id = 'typing-' + Date.now();
      div.style.display = 'flex';
      div.style.gap = '8px';
      div.style.padding = '12px 16px';
      div.style.background = '#f3f4f6';
      div.style.borderRadius = '16px';
      div.style.width = 'fit-content';
      div.innerHTML = '<span style="width: 8px; height: 8px; background: #9ca3af; border-radius: 50%; animation: bounce 1s infinite;"></span>'.repeat(3);
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      return div.id;
    }
    
    function removeTypingIndicator(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }
    
    async function showTodaySchedule() {
      try {
        const response = await fetch(`${API_BASE}/schedule/today`);
        const data = await response.json();
        
        if (data.schedules.length === 0) {
          addMessage('📅 No medications scheduled for today.', 'bot');
        } else {
          let msg = `📅 Today's Schedule (${data.schedules.length} medications):\n\n`;
          data.schedules.forEach(s => {
            const status = s.status === 'taken' ? '✅' : s.status === 'missed' ? '❌' : '⏰';
            msg += `${status} ${s.time} - ${s.name} (${s.dosage})\n`;
            if (s.with_food) msg += '   🍽️ Take with food\n';
          });
          addMessage(msg, 'bot');
        }
      } catch (error) {
        addMessage('Error fetching schedule.', 'bot', true);
      }
    }
    
    async function showStats() {
      try {
        const response = await fetch(`${API_BASE}/stats/adherence?days=30`);
        const data = await response.json();
        
        if (data.statistics.length === 0) {
          addMessage('📊 No statistics available yet.', 'bot');
        } else {
          let msg = '📊 Your 30-day Adherence:\n\n';
          data.statistics.forEach(s => {
            msg += `${s.medication_name}: ${s.adherence_rate}%\n`;
            msg += `  ✅ Taken: ${s.taken_count} | ❌ Missed: ${s.missed_count}\n\n`;
          });
          addMessage(msg, 'bot');
        }
      } catch (error) {
        addMessage('Error fetching statistics.', 'bot', true);
      }
    }
    
    async function handleAction(action) {
      console.log('🔧 Handling action:', action.type);
      
      try {
        switch (action.type) {
          case 'add_medication':
            showMedicationPreview(action.data);
            break;
          case 'add_schedule':
            showSchedulePreview(action.data);
            break;
          case 'show_schedule':
            await showTodaySchedule();
            break;
          case 'show_stats':
            await showStats();
            break;
          case 'show_refills':
            await showRefills();
            break;
          default:
            console.log('Unknown action type:', action.type);
        }
      } catch (error) {
        console.error('Action handling error:', error);
        addMessage('Sorry, I had trouble executing that action. Please try again.', 'bot', true);
      }
    }
    
    function showMedicationPreview(data) {
      // Set default quantity to 30 if not provided
      if (!data.total_quantity) {
        data.total_quantity = 30;
      }
      
      const preview = `📋 I've extracted the following medication details:

• Name: ${data.name || '(Not specified)'}
• Dosage: ${data.dosage || '(Not specified)'}
• Form: ${data.form || 'tablet'}
• Quantity: ${data.total_quantity} units
${data.purpose ? `• Purpose: ${data.purpose}` : ''}

${!data.name || !data.dosage ? '⚠️ Some required fields are missing. Please provide them before adding.' : 'Would you like to add this medication?'}`;
      
      addMessage(preview, 'bot');
      
      // Add action button
      const buttonDiv = document.createElement('div');
      buttonDiv.style.display = 'flex';
      buttonDiv.style.gap = '8px';
      buttonDiv.style.marginTop = '8px';
      buttonDiv.style.marginBottom = '16px';
      
      const addBtn = document.createElement('button');
      addBtn.textContent = '➕ Add This Medication';
      addBtn.style.cssText = 'background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;';
      addBtn.onclick = () => {
        openAddMedicationModal(data);
        buttonDiv.remove();
      };
      
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.style.cssText = 'background: #e5e7eb; color: #374151; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;';
      cancelBtn.onclick = () => {
        buttonDiv.remove();
        addMessage('Cancelled. Let me know if you need anything else!', 'bot');
      };
      
      buttonDiv.appendChild(addBtn);
      buttonDiv.appendChild(cancelBtn);
      messagesDiv.appendChild(buttonDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    function showSchedulePreview(data) {
      // Get food timing text
      const foodTimingText = data.food_timing === 'before_food' ? 'Before food' : 
                             data.food_timing === 'after_food' ? 'After food' : 
                             'No specific timing';
      
      const preview = `📅 I've extracted the following schedule details:

• Medication: ${lastAddedMedication?.name || data.medication_id ? 'Selected medication' : '(Not specified)'}
• Time: ${data.time || '(Not specified)'}
• Frequency: ${data.frequency || 'daily'}
• Food timing: ${foodTimingText}

${!data.medication_id || !data.time || !data.food_timing ? '⚠️ Some required fields are missing. Please provide them.' : 'Would you like to create this schedule?'}`;
      
      addMessage(preview, 'bot');
      
      // Add action button
      const buttonDiv = document.createElement('div');
      buttonDiv.style.display = 'flex';
      buttonDiv.style.gap = '8px';
      buttonDiv.style.marginTop = '8px';
      buttonDiv.style.marginBottom = '16px';
      
      const scheduleBtn = document.createElement('button');
      scheduleBtn.textContent = '📅 Create This Schedule';
      scheduleBtn.style.cssText = 'background: linear-gradient(135deg, #7c3aed 0%, #2563eb 100%); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;';
      scheduleBtn.onclick = () => {
        openScheduleModal(data);
        buttonDiv.remove();
      };
      
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.style.cssText = 'background: #e5e7eb; color: #374151; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;';
      cancelBtn.onclick = () => {
        buttonDiv.remove();
        addMessage('Cancelled. Let me know if you need anything else!', 'bot');
      };
      
      buttonDiv.appendChild(scheduleBtn);
      buttonDiv.appendChild(cancelBtn);
      messagesDiv.appendChild(buttonDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    function openAddMedicationModal(data) {
      // Fill the form with AI-extracted data
      document.getElementById('med-name').value = data.name || '';
      document.getElementById('med-dosage').value = data.dosage || '';
      document.getElementById('med-form').value = data.form || 'tablet';
      document.getElementById('med-purpose').value = data.purpose || '';
      
      // Set quantity (default to 30 if not provided)
      const qtyField = document.getElementById('med-quantity');
      if (data.total_quantity) {
        qtyField.value = data.total_quantity;
      } else {
        qtyField.value = '30'; // Default to 30 if not specified
      }
      
      // Open modal
      if (typeof openModal === 'function') {
        openModal('add-medication-modal');
      }
      addMessage('✅ Form opened with extracted details! Please review, enter quantity, and click "Add Medication" to confirm.', 'bot');
    }
    
    function openScheduleModal(data) {
      // We need to open the schedule modal - but first let's check if there's a function for it
      addMessage('✅ Please use the "Schedule" button on the medication card to create a schedule, or I can help you add it directly if you confirm.', 'bot');
      
      // Fallback: directly add the schedule
      const confirmBtn = document.createElement('button');
      confirmBtn.textContent = '✅ Confirm & Add Schedule';
      confirmBtn.style.cssText = 'background: linear-gradient(135deg, #7c3aed 0%, #2563eb 100%); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; margin-top: 8px; margin-bottom: 16px;';
      confirmBtn.onclick = async () => {
        await addSchedule(data);
        confirmBtn.remove();
      };
      
      messagesDiv.appendChild(confirmBtn);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    async function addMedication(data) {
      console.log('💊 Adding medication:', data);
      
      try {
        const response = await fetch(`${API_BASE}/medications`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (response.ok) {
          const result = await response.json();
          lastAddedMedication = result.medication; // Store for scheduling context
          console.log('📝 Stored last added medication:', lastAddedMedication);
          
          addMessage(`✅ Successfully added ${data.name}! The medication has been saved to your list.\n\n💡 You can now schedule it by saying: "Schedule it at 8am daily"`, 'bot');
          
          // Don't close immediately - let them schedule it
          // Close chat and refresh the page to show new medication
          setTimeout(() => {
            if (typeof loadMedications === 'function') {
              loadMedications();
            } else {
              window.location.reload();
            }
          }, 2000);
        } else {
          throw new Error('Failed to add medication');
        }
      } catch (error) {
        console.error('Error adding medication:', error);
        addMessage('❌ Failed to add medication. Please try again or add it manually using the Add Medication button.', 'bot', true);
      }
    }
    
    async function addSchedule(data) {
      console.log('📅 Adding schedule with data:', JSON.stringify(data, null, 2));
      console.log('📝 Last added medication:', lastAddedMedication);
      
      // If medication_id is missing, use last added medication
      if (!data.medication_id && lastAddedMedication) {
        console.log('💡 Using last added medication:', lastAddedMedication.name);
        data.medication_id = lastAddedMedication.id;
      }
      
      // Validate we have required fields
      if (!data.medication_id) {
        console.error('❌ Validation failed: No medication_id');
        addMessage('❌ I couldn\'t identify which medication to schedule. Please specify the medication name, like: "Schedule aspirin at 8am daily"', 'bot', true);
        return;
      }
      
      if (!data.time) {
        console.error('❌ Validation failed: No time');
        addMessage('❌ I couldn\'t identify the time. Please include a time like: "at 8am" or "at 10:30"', 'bot', true);
        return;
      }
      
      // Validate food timing (required field)
      if (!data.food_timing || data.food_timing === '') {
        console.error('❌ Validation failed: No food timing');
        addMessage('❌ Food timing is required. Please specify: before food, after food, or no specific timing. Example: "Schedule at 8am before food"', 'bot', true);
        return;
      }
      
      console.log('✅ Validation passed, calling API...');
      console.log('API URL:', `${API_BASE}/schedules`);
      console.log('Request body:', JSON.stringify(data, null, 2));
      
      try {
        const response = await fetch(`${API_BASE}/schedules`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        console.log('API Response status:', response.status);
        console.log('API Response ok:', response.ok);
        
        const responseText = await response.text();
        console.log('API Response body:', responseText);
        
        if (response.ok) {
          const result = JSON.parse(responseText);
          console.log('✅ Schedule created successfully:', result);
          
          const medName = lastAddedMedication?.name || data.medication_name || 'Your medication';
          addMessage(`✅ Schedule created! ${medName} is now scheduled for ${data.time} ${data.frequency}.`, 'bot');
          
          lastAddedMedication = null; // Clear context
          
          // Close chat and refresh
          setTimeout(() => {
            sidebar.style.transform = 'translateX(100%)';
            if (typeof loadSchedules === 'function') {
              loadSchedules();
            } else {
              window.location.reload();
            }
          }, 1500);
        } else {
          console.error('❌ API returned error status:', response.status);
          const error = JSON.parse(responseText);
          console.error('Error details:', error);
          throw new Error(error.message || error.error || 'Failed to create schedule');
        }
      } catch (error) {
        console.error('❌ Exception in addSchedule:', error);
        console.error('Error stack:', error.stack);
        addMessage(`❌ Failed to create schedule: ${error.message}. Please try again or use the Schedule button.`, 'bot', true);
      }
    }
    
    async function showRefills() {
      try {
        const response = await fetch(`${API_BASE}/medications`);
        const data = await response.json();
        
        const lowStock = data.medications.filter(m => {
          const remaining = m.quantity || 0;
          return remaining <= 10;
        });
        
        if (lowStock.length === 0) {
          addMessage('🎉 All medications have sufficient quantity!', 'bot');
        } else {
          let msg = '🔔 Medications that need refilling:\n\n';
          lowStock.forEach(m => {
            const qty = m.quantity || 0;
            msg += `⚠️ ${m.name} - Only ${qty} ${m.form || 'doses'} left\n`;
          });
          msg += '\nConsider refilling these soon!';
          addMessage(msg, 'bot');
        }
      } catch (error) {
        addMessage('Error checking refills.', 'bot', true);
      }
    }
    
    function extractScheduleDataManually(text) {
      if (!lastAddedMedication) return null;
      
      const data = {
        medication_id: lastAddedMedication.id,
        time: '',
        frequency: 'daily',
        with_food: false,
        special_instructions: '',
        start_date: new Date().toISOString().split('T')[0] // Add today's date as start_date
      };
      
      // Extract time with proper minute/period detection
      let timeMatch = null;
      let hour = 0;
      let minute = 0;
      let period = null;
      
      // Try HH:MM am/pm format
      timeMatch = text.match(/(\d{1,2}):(\d{2})\s*(am|pm)?/i);
      if (timeMatch) {
        hour = parseInt(timeMatch[1]);
        minute = parseInt(timeMatch[2]);
        period = timeMatch[3];
      } else {
        // Try H am/pm format (no minutes)
        timeMatch = text.match(/(\d{1,2})\s*(am|pm)/i);
        if (timeMatch) {
          hour = parseInt(timeMatch[1]);
          minute = 0;
          period = timeMatch[2];
        }
      }
      
      if (timeMatch) {
        // Convert to 24-hour format
        if (period && period.toLowerCase() === 'pm' && hour < 12) {
          hour += 12;
        } else if (period && period.toLowerCase() === 'am' && hour === 12) {
          hour = 0;
        }
        
        data.time = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
      }
      
      // Extract frequency
      const lowerText = text.toLowerCase();
      if (lowerText.includes('daily') || lowerText.includes('every day')) {
        data.frequency = 'daily';
      } else if (lowerText.includes('weekly')) {
        data.frequency = 'weekly';
      } else if (lowerText.includes('as needed')) {
        data.frequency = 'as_needed';
      }
      
      // Check for food requirement
      if (lowerText.includes('with food')) {
        data.with_food = true;
      }
      
      return data.time ? data : null;
    }
    
    console.log('✅ AI Chatbot ready! Button visible at bottom-right.');
  })();
  </script>
  
  <style>
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }
  </style>
  
  <!-- PWA Service Worker Registration - TEMPORARILY DISABLED -->
  <script>
    // Temporarily disabled to fix caching issues
    console.log('⚠️ Service Worker disabled for debugging');
    
    // Clear any existing service workers
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(registrations => {
        registrations.forEach(reg => {
          reg.unregister();
          console.log('🧹 Unregistered service worker:', reg.scope);
        });
      });
    }
  </script>
  
  <!-- PWA Install Prompt -->
  <script>
    // Install prompt for PWA
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      console.log('💡 App can be installed!');
      
      // Show install button after 3 seconds
      setTimeout(() => {
        if (confirm('📱 Install Medication Manager as an app on your device?')) {
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
              console.log('✅ User accepted the install prompt');
            }
            deferredPrompt = null;
          });
        }
      }, 3000);
    });
  </script>
</body>
</html>
