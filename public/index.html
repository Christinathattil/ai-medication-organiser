<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2563EB">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="description" content="Smart medication management with AI assistance, reminders, and tracking">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Medication Manager - AI Powered</title>

  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="styles/modern.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
      min-height: 100vh;
    }

    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
    }

    .card {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      background: white;
      border-radius: 20px;
      box-shadow: var(--shadow-md);
      border: 1px solid rgba(255, 255, 255, 0.8);
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-4px) scale(1.01);
      box-shadow: var(--shadow-xl);
    }

    .status-pending {
      background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
      color: #9a3412;
      font-weight: 600;
      border: 1px solid #fed7aa;
    }

    .status-taken {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      color: #166534;
      font-weight: 600;
      border: 1px solid #bbf7d0;
    }

    .status-missed {
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      color: #991b1b;
      font-weight: 600;
      border: 1px solid #fecaca;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(8px);
      animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      border-radius: 24px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(40px) scale(0.95);
        opacity: 0;
      }

      to {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }

    .severity-mild {
      color: #F59E0B;
    }

    .severity-moderate {
      color: #EF4444;
    }

    .severity-severe {
      color: #DC2626;
      font-weight: bold;
    }

    .btn-primary {
      background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(20, 184, 166, 0.4);
    }

    .stat-card {
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #14b8a6 0%, #10b981 100%);
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #14b8a6;
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
    }

    .nav-gradient {
      background: linear-gradient(135deg, #14b8a6 0%, #10b981 100%);
    }

    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      body {
        padding-bottom: 80px;
        /* Space for floating AI button */
      }

      .glass-effect {
        border-radius: 0;
      }

      nav .flex {
        flex-wrap: wrap;
      }

      nav h1 {
        font-size: 1.25rem !important;
      }

      nav p {
        font-size: 0.65rem !important;
      }

      .tab-btn {
        padding: 0.5rem 0.75rem !important;
        font-size: 0.75rem !important;
      }

      .tab-btn i {
        display: none;
        /* Hide icons on mobile to save space */
      }

      .card {
        border-radius: 12px;
      }

      .stat-card {
        padding: 1rem !important;
      }

      .stat-card .text-4xl {
        font-size: 2rem !important;
      }

      .stat-card .text-3xl {
        font-size: 1.5rem !important;
      }

      .btn-primary {
        width: 100%;
        justify-content: center;
      }

      /* Mobile Navigation - Stack vertically */
      @media (max-width: 640px) {
        nav .flex.items-center.space-x-2 {
          width: 100%;
          justify-content: space-around;
          margin-top: 0.5rem;
          gap: 0.25rem;
        }

        .tab-btn {
          padding: 0.4rem 0.5rem !important;
          font-size: 0.7rem !important;
        }
      }

      /* Modal adjustments for mobile */
      .modal>div {
        max-width: 95% !important;
        margin: 1rem !important;
        max-height: 90vh;
        overflow-y: auto;
      }

      /* Form adjustments */
      .grid.grid-cols-2 {
        grid-template-columns: 1fr !important;
      }

      /* Table responsive */
      table {
        font-size: 0.75rem;
      }

      table th,
      table td {
        padding: 0.5rem 0.25rem !important;
      }
    }

    /* Extra small devices */
    @media (max-width: 380px) {
      nav h1 {
        font-size: 1rem !important;
      }

      .tab-btn {
        padding: 0.3rem 0.4rem !important;
        font-size: 0.65rem !important;
      }
    }
  </style>
</head>

<body>
  <!-- Navigation -->
  <nav class="glass-effect shadow-lg sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8">
      <div class="flex flex-col sm:flex-row justify-between py-3 sm:py-0 sm:h-20">
        <div class="flex items-center space-x-2 sm:space-x-3 mb-2 sm:mb-0">
          <div class="bg-gradient-to-br from-teal-500 to-emerald-600 p-2 sm:p-3 rounded-xl shadow-lg">
            <i class="fas fa-pills text-xl sm:text-2xl text-white"></i>
          </div>
          <div>
            <h1 class="animated-gradient-text text-xl sm:text-2xl font-bold bg-gradient-to-r from-teal-600 to-emerald-600 bg-clip-text text-transparent">Medication Manager</h1>
            <p class="text-xs text-gray-500">Smart Medication Management</p>
          </div>
        </div>
        <div class="flex items-center space-x-1 sm:space-x-2 justify-center sm:justify-end">
          <button onclick="openSettings()" aria-label="Open Settings"
            class="p-2 rounded-xl text-gray-600 hover:bg-white hover:shadow-md transition-all">
            <i class="fas fa-cog text-xl" aria-hidden="true"></i>
          </button>
          <button onclick="handleLogout()" aria-label="Logout from account"
            class="p-2 rounded-xl text-red-600 hover:bg-red-50 hover:shadow-md transition-all" title="Logout">
            <i class="fas fa-sign-out-alt text-xl" aria-hidden="true"></i>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-8 py-4 sm:py-8 mt-2 sm:mt-4">
    <!-- Dashboard Tab -->
    <div id="dashboard-tab" class="tab-content">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Quick Stats -->
        <div class="card stat-card p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500 mb-1">Active Medications</p>
              <p class="text-4xl font-bold bg-gradient-to-r from-teal-600 to-teal-400 bg-clip-text text-transparent"
                id="stat-active-meds">0</p>
            </div>
            <div class="bg-gradient-to-br from-teal-500 to-teal-600 p-4 rounded-2xl shadow-lg">
              <i class="fas fa-pills text-3xl text-white"></i>
            </div>
          </div>
        </div>

        <div class="card stat-card p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500 mb-1">Today's Doses</p>
              <p class="text-4xl font-bold bg-gradient-to-r from-emerald-600 to-emerald-400 bg-clip-text text-transparent"
                id="stat-today-doses">0</p>
            </div>
            <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 p-4 rounded-2xl shadow-lg">
              <i class="fas fa-calendar-day text-3xl text-white"></i>
            </div>
          </div>
        </div>

        <div class="card stat-card p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500 mb-1">Adherence Rate</p>
              <p class="text-4xl font-bold bg-gradient-to-r from-indigo-600 to-indigo-400 bg-clip-text text-transparent"
                id="stat-adherence">0%</p>
            </div>
            <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 p-4 rounded-2xl shadow-lg">
              <i class="fas fa-chart-line text-3xl text-white"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Refill Alerts -->
      <div class="card p-6 mb-8" id="refill-alerts">
        <div class="flex items-center mb-4">
          <div class="bg-gradient-to-br from-orange-500 to-orange-600 p-3 rounded-xl mr-3">
            <i class="fas fa-exclamation-triangle text-white text-xl"></i>
          </div>
          <h2 class="text-2xl font-bold text-gray-800">Refill Alerts</h2>
        </div>
        <div id="refill-list"></div>
      </div>

      <!-- Today's Schedule -->
      <div class="card p-6">
        <div class="flex justify-between items-center mb-4">
          <div class="flex items-center">
            <div class="bg-gradient-to-br from-teal-500 to-teal-600 p-3 rounded-xl mr-3">
              <i class="fas fa-calendar-check text-white text-xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800">Today's Schedule</h2>
          </div>
          <button onclick="loadTodaySchedule()"
            class="bg-teal-100 text-teal-600 p-3 rounded-xl hover:bg-teal-200 transition-all">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
        <div id="today-schedule"></div>
      </div>
    </div>

    <!-- Medications Tab -->
    <div id="medications-tab" class="tab-content hidden">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 sm:mb-6 gap-3">
        <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Medications</h2>
        <button onclick="showAddMedicationModal()"
          class="btn-primary text-white px-6 py-3 rounded-xl font-semibold shadow-lg w-full sm:w-auto">
          <i class="fas fa-plus mr-2"></i>Add Medication
        </button>
      </div>

      <div class="mb-4">
        <input type="text" id="search-meds" placeholder="Search medications..."
          class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" onkeyup="searchMedications()">
      </div>

      <div id="medications-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

    <!-- Schedules Tab -->
    <div id="schedules-tab" class="tab-content hidden">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 sm:mb-6 gap-3">
        <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Medication Schedules</h2>
        <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
          <select id="schedule-sort" onchange="loadSchedules()"
            class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
            <option value="time">Sort by Time</option>
            <option value="medication">Sort by Medication</option>
            <option value="frequency">Sort by Frequency</option>
          </select>
          <label class="flex items-center px-4 py-2 bg-gray-100 rounded-lg cursor-pointer">
            <input type="checkbox" id="schedule-group" onchange="loadSchedules()" class="mr-2">
            <span class="text-sm font-medium text-gray-700">Group by Time</span>
          </label>
          <button onclick="showAddScheduleModal()"
            class="btn-primary text-white px-6 py-3 rounded-xl font-semibold shadow-lg">
            <i class="fas fa-plus mr-2"></i>Add Schedule
          </button>
        </div>
      </div>
      <div id="schedules-list"></div>
    </div>

    <!-- History Tab -->
    <div id="history-tab" class="tab-content hidden">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Medication History</h2>
      <div class="bg-white rounded-lg shadow-sm p-6">
        <div id="history-list"></div>
      </div>
    </div>

    <!-- Stats Tab -->
    <div id="stats-tab" class="tab-content hidden">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Adherence Statistics</h2>
      <div class="bg-white rounded-lg shadow-sm p-6">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Period</label>
          <select id="stats-period" onchange="loadAdherenceStats()" class="px-4 py-2 border rounded-lg">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
          </select>
        </div>
        <div id="stats-list"></div>
      </div>
    </div>
  </div>

  <!-- Add Medication Modal -->
  <div id="add-medication-modal" class="modal">
    <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
      <h2 class="text-2xl font-bold mb-6">Add New Medication</h2>
      <form id="medication-form" onsubmit="addMedication(event)">
        <div class="grid grid-cols-2 gap-4">
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Medication Name *</label>
            <input type="text" id="med-name" name="name" required
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Dosage *</label>
            <input type="text" id="med-dosage" name="dosage" required placeholder="e.g., 500mg"
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Form *</label>
            <select id="med-form" name="form" required
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="">Select form</option>
              <option value="tablet">Tablet</option>
              <option value="capsule">Capsule</option>
              <option value="syrup">Syrup</option>
              <option value="injection">Injection</option>
              <option value="drops">Drops</option>
              <option value="cream">Cream</option>
              <option value="inhaler">Inhaler</option>
            </select>
          </div>

          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Purpose</label>
            <input type="text" id="med-purpose" name="purpose" placeholder="What is this for?"
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Prescribing Doctor</label>
            <input type="text" id="med-doctor" name="prescribing_doctor"
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Prescription Date</label>
            <input type="date" id="med-prescription-date" name="prescription_date"
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Total Quantity</label>
            <input type="number" id="med-quantity" name="total_quantity" placeholder="e.g., 30 (optional)" min="1"
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>

          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Side Effects</label>
            <textarea id="med-side-effects" name="side_effects" rows="2"
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
          </div>

          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
            <textarea id="med-notes" name="notes" rows="2"
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
          </div>

          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">ðŸ“¸ Photo (Optional)</label>
            <input type="file" name="photo" accept="image/*"
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
            <p class="text-xs text-gray-500 mt-1">Upload a photo of the medication (max 5MB)</p>
          </div>
        </div>

        <div class="flex justify-end space-x-4 mt-6">
          <button type="button" onclick="closeModal('add-medication-modal')"
            class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add
            Medication</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Schedule Modal -->
  <div id="add-schedule-modal" class="modal">
    <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4">
      <h3 class="text-2xl font-bold mb-6">Add Schedule</h3>
      <form id="add-schedule-form" onsubmit="addSchedule(event)">
        <div class="grid grid-cols-2 gap-4">
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Medication *</label>
            <select name="medication_id" id="schedule-medication-select" required
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="">Select medication</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Time *</label>
            <input type="time" name="time" required
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Frequency *</label>
            <select name="frequency" required
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="as_needed">As Needed</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Start Date *</label>
            <input type="date" name="start_date" required
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
            <input type="date" name="end_date"
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>

          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Days of Week (for weekly)</label>
            <input type="text" name="days_of_week" placeholder="e.g., Mon,Wed,Fri"
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>

          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Food Timing *</label>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="radio" name="food_timing" value="none" required class="mr-2">
                <span class="text-sm text-gray-700">No specific timing</span>
              </label>
              <label class="flex items-center">
                <input type="radio" name="food_timing" value="before_food" required class="mr-2">
                <span class="text-sm text-gray-700">Before food</span>
              </label>
              <label class="flex items-center">
                <input type="radio" name="food_timing" value="after_food" required class="mr-2">
                <span class="text-sm text-gray-700">After food</span>
              </label>
            </div>
          </div>

          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Special Instructions</label>
            <textarea name="special_instructions" rows="2"
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
        </div>

        <div class="flex justify-end space-x-4 mt-6">
          <button type="button" onclick="closeModal('add-schedule-modal')"
            class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add
            Schedule</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Schedule Modal -->
  <div id="edit-schedule-modal" class="modal">
    <div class="bg-white rounded-lg p-6 md:p-8 max-w-2xl w-full mx-4">
      <h3 class="text-xl md:text-2xl font-bold mb-6">Edit Schedule</h3>
      <form id="edit-schedule-form" onsubmit="updateSchedule(event)">
        <input type="hidden" id="edit-schedule-id" name="schedule_id">

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="col-span-1 md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Medication</label>
            <select id="edit-medication-select" name="medication_id" required
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="">Select medication...</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Time</label>
            <input type="time" name="time" id="edit-schedule-time" required
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Frequency</label>
            <select name="frequency" id="edit-schedule-frequency" required
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="as_needed">As Needed</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
            <input type="date" name="start_date" id="edit-schedule-start"
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">End Date (Optional)</label>
            <input type="date" name="end_date" id="edit-schedule-end"
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>

          <div class="col-span-1 md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Food Timing *</label>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="radio" name="food_timing" value="none" id="edit-schedule-food-none" required class="mr-2">
                <span class="text-sm text-gray-700">No specific timing</span>
              </label>
              <label class="flex items-center">
                <input type="radio" name="food_timing" value="before_food" id="edit-schedule-food-before" required
                  class="mr-2">
                <span class="text-sm text-gray-700">Before food</span>
              </label>
              <label class="flex items-center">
                <input type="radio" name="food_timing" value="after_food" id="edit-schedule-food-after" required
                  class="mr-2">
                <span class="text-sm text-gray-700">After food</span>
              </label>
            </div>
          </div>

          <div class="col-span-1 md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Special Instructions</label>
            <textarea name="special_instructions" id="edit-schedule-instructions" rows="2"
              class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
          </div>
        </div>

        <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4 mt-6">
          <button type="button" onclick="closeModal('edit-schedule-modal')"
            class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update
            Schedule</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ==================== INLINE AI CHATBOT (NO CACHING) ==================== -->
  <!-- Chatbot Button - Always Visible, Embedded Directly -->
  <button id="ai-chat-toggle"
    style="position: fixed; bottom: 24px; right: 24px; z-index: 999999; width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, #14b8a6 0%, #10b981 100%); border: none; cursor: pointer; box-shadow: 0 10px 30px rgba(20, 184, 166, 0.5); display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">
    <svg style="width: 32px; height: 32px; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
      </path>
    </svg>
    <span
      style="position: absolute; top: -2px; right: -2px; background: #10b981; color: white; font-size: 11px; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-weight: bold;">AI</span>
  </button>

  <!-- Chatbot Sidebar -->
  <div id="ai-chat-sidebar"
    style="position: fixed; top: 0; right: 0; bottom: 0; width: 100%; max-width: 450px; background: white; box-shadow: -5px 0 30px rgba(0,0,0,0.3); transform: translateX(100%); transition: transform 0.3s ease; z-index: 999998; display: flex; flex-direction: column;">
    <!-- Header -->
    <div
      style="background: linear-gradient(135deg, #14b8a6 0%, #10b981 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
          <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z">
            </path>
          </svg>
        </div>
        <div>
          <h3 style="margin: 0; font-size: 18px; font-weight: bold;">AI Health Assistant</h3>
          <p style="margin: 0; font-size: 12px; opacity: 0.9;">Hi! Iâ€™m your med companion â€” here to simplify your routine.</p>
        </div>
      </div>
      <button id="ai-chat-close"
        style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
        <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Messages -->
    <div id="ai-chat-messages"
      style="flex: 1; overflow-y: auto; padding: 20px; background: linear-gradient(to bottom, #f9fafb, #ffffff); padding-bottom: 20px;">
    </div>

    <!-- Input Area (Sticky Bottom) -->
    <div
      style="padding: 16px; border-top: 1px solid #e5e7eb; background: white; flex-shrink: 0; padding-bottom: calc(16px + env(safe-area-inset-bottom));">
      <div class="chat-input-container" style="display: flex; gap: 8px; margin-bottom: 12px;">
        <button id="voice-btn" class="voice-btn" onclick="startVoiceInput('chat-input')"
          style="width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #059669); border: none; color: white; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center;"
          title="Voice input">
          <i class="fas fa-microphone" style="font-size: 18px;"></i>
        </button>
        <input type="text" id="chat-input" placeholder="Ask me anything..."
          style="flex: 1; padding: 10px 16px; font-size: 15px; border: 1px solid #e5e7eb; border-radius: 24px; outline: none; background: #f9fafb;">
        <button id="send-btn" onclick="sendMessage()"
          style="width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); border: none; color: white; cursor: pointer; font-weight: 600; flex-shrink: 0; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-paper-plane" style="font-size: 16px;"></i>
        </button>
      </div>

      <!-- Quick Actions (Always Visible) -->
      <div style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; -webkit-overflow-scrolling: touch;">
        <button class="quick-btn" data-action="today"
          style="background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; white-space: nowrap; flex-shrink: 0;">
          ðŸ“… Today's Meds
        </button>
        <button class="quick-btn" data-action="add"
          style="background: #f0fdf4; color: #15803d; border: 1px solid #dcfce7; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; white-space: nowrap; flex-shrink: 0;">
          âž• Add Med
        </button>
        <button class="quick-btn" data-action="stats"
          style="background: #faf5ff; color: #7e22ce; border: 1px solid #f3e8ff; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500; white-space: nowrap; flex-shrink: 0;">
          ðŸ“Š My Stats
        </button>
      </div>
    </div>
  </div>

  <script src="app.js?v=2"></script>

  <!-- ==================== INLINE AI CHATBOT LOGIC (NO EXTERNAL FILES) ==================== -->
  <script>
    console.log('ðŸ¤– AI Chatbot initializing (inline, no cache)...');

    // Global logout function (must be outside IIFE for onclick access)
    window.handleLogout = async function () {
      if (confirm('Are you sure you want to logout?')) {
        try {
          await fetch('/auth/logout');
          window.location.href = '/login';
        } catch (error) {
          console.error('Logout error:', error);
          alert('Failed to logout. Please try again.');
        }
      }
    };

    (function () {
      const CHAT_API_BASE = '/api';
      let currentMedicationForSchedule = null;
      let lastAddedMedication = null;
      let isProcessing = false; // Track if a message is being sent
      let chatHistory = []; // Store conversation history

      // DOM elements
      const toggleBtn = document.getElementById('ai-chat-toggle');
      const sidebar = document.getElementById('ai-chat-sidebar');
      const closeBtn = document.getElementById('ai-chat-close');
      const logoutBtn = document.getElementById('ai-chat-logout');
      const sendBtn = document.getElementById('ai-chat-send');
      const input = document.getElementById('ai-chat-input');
      const messagesDiv = document.getElementById('ai-chat-messages');

      console.log('âœ… AI Chatbot elements found:', {
        toggleBtn: !!toggleBtn,
        sidebar: !!sidebar,
        closeBtn: !!closeBtn,
        sendBtn: !!sendBtn,
        input: !!input,
        messagesDiv: !!messagesDiv
      });

      // Add welcome message
      addMessage('ðŸ‘‹ Hi! I\'m your med companion â€” here to simplify your routine.\n\nI can help you:\n\nâ€¢ Add medications naturally\nâ€¢ Create schedules\nâ€¢ Check your plan\nâ€¢ View statistics\n\nTry: "Add aspirin 500mg for headaches"', 'bot');

      // Chatbot Toggle Logic
      const chatToggleBtn = document.getElementById('ai-chat-toggle');
      const chatSidebar = document.getElementById('ai-chat-sidebar');
      const closeChatBtn = document.getElementById('close-chat-btn'); // Ensure this ID matches your HTML

      // Utility to hide chat sidebar if it is open
      function closeChatSidebar() {
        if (chatSidebar && chatSidebar.style.transform === 'translateX(0%)') {
          toggleChat();
        }
      }

      function toggleChat() {
        const isOpen = chatSidebar.style.transform === 'translateX(0%)';
        if (isOpen) {
          chatSidebar.style.transform = 'translateX(100%)';
          // Change icon back to chat bubble
          chatToggleBtn.innerHTML = `
            <svg style="width: 32px; height: 32px; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
            </svg>
            <span style="position: absolute; top: -2px; right: -2px; background: #ef4444; color: white; font-size: 11px; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-weight: bold;">AI</span>
          `;
        } else {
          chatSidebar.style.transform = 'translateX(0%)';
          // Change icon to X (close)
          chatToggleBtn.innerHTML = `
            <svg style="width: 32px; height: 32px; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          `;
          // Focus input
          setTimeout(() => document.getElementById('chat-input').focus(), 300);
        }
      }

      // Auto-click helper for confirmations
      function autoClick(btn, container, delay = 3000) {
        try {
          setTimeout(() => {
            if (container && container.isConnected && typeof btn?.click === 'function') {
              btn.click();
            }
          }, delay);
        } catch (e) {
          console.warn('autoClick failed', e);
        }
      }

      // Event Listeners
      if (toggleBtn) toggleBtn.addEventListener('click', toggleChat);
      if (closeBtn) closeBtn.addEventListener('click', toggleChat);
      if (sendBtn) sendBtn.addEventListener('click', sendMessage);
      if (input) {
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !isProcessing) sendMessage();
        });
      }

      // Quick Action Buttons
      document.querySelectorAll('.quick-btn').forEach(btn => {
        toggleBtn.style.boxShadow = '0 10px 30px rgba(124, 58, 237, 0.5)';
      });

      async function sendMessage() {
        let message = input.value.trim();
        if (!message || isProcessing) return;

        // If user says "schedule it" and we have last medication, replace "it" with medication name
        if (lastAddedMedication &&
          (message.toLowerCase().includes('schedule it') ||
            message.toLowerCase().includes('schedule the medication'))) {
          message = message.replace(/\bit\b/gi, lastAddedMedication.name);
          message = message.replace(/the medication/gi, lastAddedMedication.name);
          console.log('ðŸ’¡ Replaced "it" with medication name:', message);
        }
        const chatInput = input; // Alias for consistency with provided snippet
        // UI Updates
        chatInput.value = '';
        chatInput.disabled = true;
        sendBtn.disabled = true;
        sendBtn.style.opacity = '0.5';
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        isProcessing = true;
        addMessage(message, 'user');

        // Show typing indicator
        const typingId = addTypingIndicator();

        try {
          const response = await fetch(`${CHAT_API_BASE}/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message,
              history: chatHistory.slice(-10) // Keep context manageable
            })
          });

          removeTypingIndicator(typingId);

          if (response.ok) {
            const data = await response.json();
            addMessage(data.response, 'bot');
            chatHistory.push(
              { role: 'user', content: message },
              { role: 'assistant', content: data.response }
            );

            // Handle fallback to manual forms
            if (data.fallback && data.action?.type === 'fallback_to_manual_forms') {
              console.log('âš ï¸ AI fallback triggered - opening manual form');
              if (message.toLowerCase().includes('schedule') || message.toLowerCase().includes('reminder')) {
                setTimeout(() => showAddScheduleModal(), 1000);
              } else {
                setTimeout(() => showAddMedicationModal(), 1000);
              }
            }
            // Handle action if AI detected intent
            else if (data.action) {
              console.log('ðŸŽ¯ Action detected:', data.action);
              await handleAction(data.action);
            } else if (lastAddedMedication &&
              (message.toLowerCase().includes('schedule') &&
                message.toLowerCase().includes(lastAddedMedication.name.toLowerCase()))) {
              // Manual fallback if server didn't detect action but we have context
              console.log('ðŸ’¡ No action from server, attempting manual schedule...');
              const scheduleData = extractScheduleDataManually(message);
              if (scheduleData) {
                await handleAction({ type: 'add_schedule', data: scheduleData });
              }
            }
          } else {
            const error = await response.json().catch(() => ({}));
            let errorMsg = 'Sorry, I encountered an error.';
            if (response.status === 500) errorMsg = 'Server error. Please try again.';
            else if (response.status === 401 || response.status === 403) {
              errorMsg = 'Authentication error. Please refresh and log in again.';
            } else if (response.status === 400) {
              errorMsg = error.response || error.error || 'Invalid request. Please try rephrasing your message.';
            } else {
              errorMsg = error.response || error.error || 'An error occurred. Please try again.';
            }
            addMessage(errorMsg, 'bot', true);
            console.error('Chat API error:', { status: response.status, error });
          }
        } catch (error) {
          removeTypingIndicator(typingId);
          addMessage('Connection error. Please check your internet.', 'bot', true);
          console.error('Chat error:', error);
        } finally {
          isProcessing = false;
          chatInput.disabled = false;
          sendBtn.disabled = false;
          sendBtn.style.opacity = '1';
          sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
          chatInput.focus();
        }
      }

      function addMessage(text, sender, isError = false) {
        const div = document.createElement('div');
        div.style.marginBottom = '16px';
        div.style.display = 'flex';
        div.style.flexDirection = sender === 'user' ? 'row-reverse' : 'row';
        div.style.gap = '8px';

        const bubble = document.createElement('div');
        bubble.style.padding = '12px 16px';
        bubble.style.borderRadius = '18px';
        bubble.style.maxWidth = '85%';
        bubble.style.fontSize = '15px';
        bubble.style.lineHeight = '1.5';
        bubble.style.whiteSpace = 'pre-line';
        bubble.style.boxShadow = '0 1px 2px rgba(0,0,0,0.05)';

        if (sender === 'user') {
          bubble.style.background = '#0f172a'; /* Primary Dark Blue */
          bubble.style.color = 'white';
          bubble.style.marginLeft = 'auto';
          bubble.style.borderBottomRightRadius = '4px';
        } else {
          bubble.style.background = isError ? '#fee2e2' : '#ffffff';
          bubble.style.color = isError ? '#991b1b' : '#1e293b';
          bubble.style.border = isError ? '1px solid #fecaca' : '1px solid #e2e8f0';
          bubble.style.borderBottomLeftRadius = '4px';
        }

        bubble.textContent = text;
        div.appendChild(bubble);
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        return div;
      }

      function addTypingIndicator() {
        const div = document.createElement('div');
        div.id = 'typing-' + Date.now();
        div.style.display = 'flex';
        div.style.gap = '8px';
        div.style.padding = '12px 16px';
        div.style.background = '#f3f4f6';
        div.style.borderRadius = '16px';
        div.style.width = 'fit-content';
        div.innerHTML = '<span style="width: 8px; height: 8px; background: #9ca3af; border-radius: 50%; animation: bounce 1s infinite;"></span>'.repeat(3);
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        return div.id;
      }

      function removeTypingIndicator(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
      }

      async function showTodaySchedule() {
        try {
          const response = await fetch(`${CHAT_API_BASE}/schedules/today`);
          const data = await response.json();

          if (data.schedules.length === 0) {
            addMessage('ðŸ“… No medications scheduled for today.', 'bot');
          } else {
            let msg = `ðŸ“… Today's Schedule (${data.schedules.length} medications):\n\n`;
            data.schedules.forEach(s => {
              const status = s.status === 'taken' ? 'âœ…' : s.status === 'missed' ? 'âŒ' : 'â°';
              msg += `${status} ${s.time} - ${s.name} (${s.dosage})\n`;
              if (s.with_food) msg += '   ðŸ½ï¸ Take with food\n';
            });
            addMessage(msg, 'bot');
          }
        } catch (error) {
          addMessage('Error fetching schedule.', 'bot', true);
        }
      }

      async function showStats() {
        try {
          const response = await fetch(`${CHAT_API_BASE}/stats/adherence?days=30`);
          const data = await response.json();

          if (data.statistics.length === 0) {
            addMessage('ðŸ“Š No statistics available yet.', 'bot');
          } else {
            let msg = 'ðŸ“Š Your 30-day Adherence:\n\n';
            data.statistics.forEach(s => {
              msg += `${s.medication_name}: ${s.adherence_rate}%\n`;
              msg += `  âœ… Taken: ${s.taken_count} | âŒ Missed: ${s.missed_count}\n\n`;
            });
            addMessage(msg, 'bot');
          }
        } catch (error) {
          addMessage('Error fetching statistics.', 'bot', true);
        }
      }

      async function handleAction(action) {
        console.log('ðŸ”§ Handling action:', action.type);

        try {
          switch (action.type) {
            case 'add_medication':
              showMedicationPreview(action.data);
              break;
            case 'add_schedule':
              showSchedulePreview(action.data);
              break;
            case 'add_medication_and_schedule':
              showCombinedPreview(action.data);
              break;
            case 'show_schedule':
              await showTodaySchedule();
              break;
            case 'show_stats':
              await showStats();
              break;
            case 'show_refills':
              await showRefills();
              break;
            case 'delete_medication':
              showDeleteMedicationConfirmation(action.data);
              break;
            case 'delete_all_medications':
              showDeleteAllMedicationsConfirmation(action.data);
              break;
            case 'delete_schedule':
              showDeleteScheduleConfirmation(action.data);
              break;
            case 'update_medication':
              showUpdateMedicationPreview(action.data);
              break;
            case 'update_schedule':
              showUpdateSchedulePreview(action.data);
              break;
            default:
              console.log('Unknown action type:', action.type);
          }
        } catch (error) {
          console.error('Action handling error:', error);
          addMessage('Sorry, I had trouble executing that action. Please try again.', 'bot', true);
        }
      }

      function showMedicationPreview(data) {
        // Set default quantity to 30 if not provided
        if (!data.total_quantity) {
          data.total_quantity = 30;
        }

        // Check if we have required fields
        if (!data.name || !data.dosage) {
          const preview = `ðŸ“‹ I've extracted the following medication details:

â€¢ Name: ${data.name || '(Not specified)'}
â€¢ Dosage: ${data.dosage || '(Not specified)'}
â€¢ Form: ${data.form || 'tablet'}
â€¢ Quantity: ${data.total_quantity} units
${data.purpose ? `â€¢ Purpose: ${data.purpose}` : ''}

âš ï¸ Some required fields are missing. Please provide them before adding.`;
          addMessage(preview, 'bot');
          return;
        }

        // Inform user that form is being opened
        addMessage(`ðŸ“‹ I've extracted the medication details. Opening the form for you to review and confirm...`, 'bot');

        // Pre-fill and open the medication form
        openAndFillMedicationForm(data);
      }

      // Helper function to open and pre-fill medication form (robust)
      function openAndFillMedicationForm(data) {
        try {
          const setValue = (id, value) => {
            const el = document.getElementById(id);
            if (el != null && value !== undefined) el.value = value;
          };

          // Fill the form with extracted data
          setValue('med-name', data.name || '');
          setValue('med-dosage', data.dosage || '');
          setValue('med-form', data.form || 'tablet');
          setValue('med-purpose', data.purpose || '');
          setValue('med-quantity', data.total_quantity || 30);

          // Fill optional fields if provided
          if (data.prescribing_doctor) setValue('med-doctor', data.prescribing_doctor);
          if (data.prescription_date) setValue('med-prescription-date', data.prescription_date);
          if (data.side_effects) setValue('med-side-effects', data.side_effects);
          if (data.notes) setValue('med-notes', data.notes);

          // Reset modal to add mode (not edit mode)
          const form = document.getElementById('medication-form');
          if (form) form.removeAttribute('data-edit-id');
          const titleEl = document.querySelector('#add-medication-modal h2');
          if (titleEl) titleEl.textContent = 'Add New Medication';
          const submitBtn = document.querySelector('#medication-form button[type="submit"]');
          if (submitBtn) submitBtn.textContent = 'Add Medication';
        } catch (err) {
          console.error('openAndFillMedicationForm error:', err);
        }

        // Always attempt to open the modal even if some fields failed to prefill
        const modal = document.getElementById('add-medication-modal');
        if (modal) {
          modal.classList.add('active');
          modal.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else if (typeof openModal === 'function') openModal('add-medication-modal');

        // Hide chat sidebar so user sees the form
        closeChatSidebar();

        // Guide the user
        setTimeout(() => {
          addMessage('âœ… Form opened! Please review the details, make any changes if needed, and click "Add Medication" to confirm.', 'bot');
        }, 500);
      }

      function showSchedulePreview(data) {
        // Check if we have required fields
        if (!data.medication_id || !data.time || !data.food_timing) {
          const foodTimingText = data.food_timing === 'before_food' ? 'Before food' :
            data.food_timing === 'after_food' ? 'After food' :
              data.food_timing === 'with_food' ? 'With food' :
                'No specific timing';

          const preview = `ðŸ“… I've extracted the following schedule details:

â€¢ Medication: ${lastAddedMedication?.name || data.medication_id ? 'Selected medication' : '(Not specified)'}
â€¢ Time: ${data.time || '(Not specified)'}
â€¢ Frequency: ${data.frequency || 'daily'}
â€¢ Food timing: ${foodTimingText}

âš ï¸ Some required fields are missing. Please provide them.`;

          addMessage(preview, 'bot');
          return;
        }

        // Inform user that form is being opened
        addMessage(`ðŸ“… I've extracted the schedule details. Opening the form for you to review and confirm...`, 'bot');

        // Pre-fill and open the schedule form
        openAndFillScheduleForm(data);
      }

      // Helper function to open and pre-fill schedule form (robust)
      async function openAndFillScheduleForm(data) {
        try {
          // First, load medications for the dropdown
          if (typeof loadMedicationsForSchedule === 'function') {
            await loadMedicationsForSchedule();
          }

          // Fill the form with extracted data
          const medSelect = document.getElementById('schedule-medication-select');
          if (medSelect && data.medication_id) medSelect.value = data.medication_id;

          // Fill time field
          const timeInput = document.querySelector('#add-schedule-form input[name="time"]');
          if (timeInput && data.time) timeInput.value = data.time;

          // Fill frequency field
          const frequencySelect = document.querySelector('#add-schedule-form select[name="frequency"]');
          if (frequencySelect && data.frequency) frequencySelect.value = data.frequency;

          // Fill start date (default to today if not provided)
          const startDateInput = document.querySelector('#add-schedule-form input[name="start_date"]');
          if (startDateInput) startDateInput.value = data.start_date || new Date().toISOString().split('T')[0];

          // Fill end date if provided
          if (data.end_date) {
            const endDateInput = document.querySelector('#add-schedule-form input[name="end_date"]');
            if (endDateInput) endDateInput.value = data.end_date;
          }

          // Fill days of week if provided
          if (data.days_of_week) {
            const daysInput = document.querySelector('#add-schedule-form input[name="days_of_week"]');
            if (daysInput) daysInput.value = data.days_of_week;
          }

          // Fill food timing radio button
          if (data.food_timing) {
            const foodRadio = document.querySelector(`#add-schedule-form input[name="food_timing"][value="${data.food_timing}"]`);
            if (foodRadio) foodRadio.checked = true;
          }

          // Fill special instructions if provided
          if (data.special_instructions) {
            const instructionsTextarea = document.querySelector('#add-schedule-form textarea[name="special_instructions"]');
            if (instructionsTextarea) instructionsTextarea.value = data.special_instructions;
          }
        } catch (err) {
          console.error('openAndFillScheduleForm error:', err);
        }

        // Always attempt to open the modal
        const modal = document.getElementById('add-schedule-modal');
        if (modal) {
          modal.classList.add('active');
          modal.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else if (typeof openModal === 'function') openModal('add-schedule-modal');

        // Hide chat sidebar so user sees the form
        closeChatSidebar();

        // Guide the user
        setTimeout(() => {
          addMessage('âœ… Form opened! Please review the details, make any changes if needed, and click "Add Schedule" to confirm.', 'bot');
        }, 500);
      }

      function showCombinedPreview(data) {
        const medData = data.medication;
        const schedData = data.schedule;

        // Set default quantity to 30 if not provided
        if (!medData.total_quantity) {
          medData.total_quantity = 30;
        }

        // Check if we have required fields for both medication and schedule
        if (!medData.name || !medData.dosage || !schedData.time || !schedData.food_timing) {
          const foodTimingText = schedData.food_timing === 'before_food' ? 'Before food' :
            schedData.food_timing === 'after_food' ? 'After food' :
              schedData.food_timing === 'with_food' ? 'With food' :
                'No specific timing';

          const preview = `ðŸ“‹ I've extracted the following details:

**Medication:**
â€¢ Name: ${medData.name || '(Not specified)'}
â€¢ Dosage: ${medData.dosage || '(Not specified)'}
â€¢ Form: ${medData.form || 'tablet'}
â€¢ Quantity: ${medData.total_quantity} units

**Schedule:**
â€¢ Time: ${schedData.time || '(Not specified)'}
â€¢ Frequency: ${schedData.frequency || 'daily'}
â€¢ Food timing: ${foodTimingText}

âš ï¸ Some required fields are missing. Please provide them before adding.`;

          addMessage(preview, 'bot');
          return;
        }

        // Inform user about the combined action
        addMessage(`ðŸ“‹ I've extracted both medication and schedule details. First, I'll open the medication form for you to review...`, 'bot');

        // First, open and fill medication form
        openAndFillMedicationForm(medData);

        // After user adds the medication, we'll need to wait for it and then open schedule form
        // This will be handled by the addMedicationAndSchedule flow
        // Store schedule data for later use
        window.pendingScheduleData = schedData;

        // Add guidance message
        setTimeout(() => {
          addMessage(`After adding the medication, I'll automatically open the schedule form next.`, 'bot');
        }, 1000);
      }

      // Expose preview helpers globally for robust action handling
      window.showMedicationPreview = showMedicationPreview;
      window.showSchedulePreview = showSchedulePreview;
      window.showCombinedPreview = showCombinedPreview;

      async function addMedicationAndSchedule(medData, schedData) {
        try {
          // First, add the medication
          const medResponse = await fetch('/api/medications', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(medData)
          });

          if (!medResponse.ok) {
            throw new Error('Failed to add medication');
          }

          const medResult = await medResponse.json();
          const medicationId = medResult.medication_id;

          // Save for reference
          lastAddedMedication = { id: medicationId, name: medData.name };

          console.log('âœ… Medication added:', medicationId);
          addMessage(`âœ… Successfully added ${medData.name}!`, 'bot');

          // Now add the schedule using the medication ID
          const schedulePayload = {
            medication_id: medicationId,
            time: schedData.time,
            frequency: schedData.frequency || 'daily',
            food_timing: schedData.food_timing,
            start_date: new Date().toISOString().split('T')[0]
          };

          const schedResponse = await fetch('/api/schedules', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(schedulePayload)
          });

          if (!schedResponse.ok) {
            throw new Error('Failed to add schedule');
          }

          console.log('âœ… Schedule added');
          addMessage(`âœ… Schedule created for ${schedData.time} ${schedData.frequency}!`, 'bot');

          // Refresh the medications list
          if (typeof loadMedications === 'function') {
            await loadMedications();
          }

          // Refresh schedule if on schedule page
          if (typeof loadSchedules === 'function') {
            await loadSchedules();
          }

        } catch (error) {
          console.error('Error adding medication and schedule:', error);
          addMessage('âŒ Failed to add medication and schedule. Please try again.', 'bot', true);
        }
      }

      function openAddMedicationModal(data) {
        // Fill the form with AI-extracted data
        document.getElementById('med-name').value = data.name || '';
        document.getElementById('med-dosage').value = data.dosage || '';
        document.getElementById('med-form').value = data.form || 'tablet';
        document.getElementById('med-purpose').value = data.purpose || '';

        // Set quantity (default to 30 if not provided)
        const qtyField = document.getElementById('med-quantity');
        if (data.total_quantity) {
          qtyField.value = data.total_quantity;
        } else {
          qtyField.value = '30'; // Default to 30 if not specified
        }

        // Open modal
        if (typeof openModal === 'function') {
          openModal('add-medication-modal');
        }
        addMessage('âœ… Form opened with extracted details! Please review, enter quantity, and click "Add Medication" to confirm.', 'bot');
      }

      function openScheduleModal(data) {
        // We need to open the schedule modal - but first let's check if there's a function for it
        addMessage('âœ… Please use the "Schedule" button on the medication card to create a schedule, or I can help you add it directly if you confirm.', 'bot');

        // Fallback: directly add the schedule
        const confirmBtn = document.createElement('button');
        confirmBtn.textContent = 'âœ… Confirm & Add Schedule';
        confirmBtn.style.cssText = 'background: linear-gradient(135deg, #7c3aed 0%, #2563eb 100%); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; margin-top: 8px; margin-bottom: 16px;';
        confirmBtn.onclick = async () => {
          await addSchedule(data);
          confirmBtn.remove();
        };

        messagesDiv.appendChild(confirmBtn);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      async function addMedicationFromChat(data) {
        console.log('ðŸ’Š Adding medication:', data);

        // Clean up data before sending
        const cleanData = {
          name: data.name,
          dosage: data.dosage,
          form: data.form || 'tablet',
          purpose: data.purpose && data.purpose.length >= 3 ? data.purpose : '',
          total_quantity: data.total_quantity || 30
        };

        console.log('ðŸ§¹ Cleaned data:', cleanData);

        try {
          const response = await fetch(`${CHAT_API_BASE}/medications`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(cleanData)
          });

          if (response.ok) {
            const result = await response.json();
            lastAddedMedication = result.medication; // Store for scheduling context
            console.log('ðŸ“ Stored last added medication:', lastAddedMedication);

            addMessage(`âœ… Successfully added ${data.name}! The medication has been saved to your list.`, 'bot');

            // Ask if they want to schedule it
            const schedulePrompt = document.createElement('div');
            schedulePrompt.style.cssText = 'margin-top: 12px; margin-bottom: 16px;';

            const promptText = document.createElement('p');
            promptText.textContent = 'ðŸ’¡ Would you like to create a schedule for this medication?';
            promptText.style.cssText = 'margin-bottom: 8px; color: #374151;';
            schedulePrompt.appendChild(promptText);

            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = 'display: flex; gap: 8px;';

            const yesBtn = document.createElement('button');
            yesBtn.textContent = 'ðŸ“… Yes, Schedule It';
            yesBtn.style.cssText = 'background: linear-gradient(135deg, #7c3aed 0%, #2563eb 100%); color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px;';
            yesBtn.onclick = () => {
              schedulePrompt.remove();
              addMessage('Great! What time should you take it? (e.g., "8am daily before food")', 'bot');
            };

            const noBtn = document.createElement('button');
            noBtn.textContent = 'Not Now';
            noBtn.style.cssText = 'background: #e5e7eb; color: #374151; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px;';
            noBtn.onclick = () => {
              schedulePrompt.remove();
              addMessage('No problem! You can schedule it anytime by saying: "Schedule ' + data.name + ' at [time]"', 'bot');
            };

            buttonContainer.appendChild(yesBtn);
            buttonContainer.appendChild(noBtn);
            schedulePrompt.appendChild(buttonContainer);

            messagesDiv.appendChild(schedulePrompt);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Don't close immediately - let them schedule it
            // Close chat and refresh the page to show new medication
            setTimeout(() => {
              if (typeof loadMedications === 'function') {
                loadMedications();
              } else {
                window.location.reload();
              }
            }, 2000);
          } else {
            // Get error details from backend
            let errorMsg = 'Failed to add medication';
            try {
              const errorData = await response.json();
              errorMsg = errorData.error || errorData.message || errorMsg;

              // Check for duplicate error
              if (errorMsg.toLowerCase().includes('already exists') ||
                errorMsg.toLowerCase().includes('duplicate') ||
                response.status === 409) {
                addMessage(`âš ï¸ ${data.name} is already in your medication list. Would you like to update it instead?`, 'bot', true);
                return;
              }
            } catch (e) {
              console.error('Error parsing error response:', e);
            }

            throw new Error(errorMsg);
          }
        } catch (error) {
          console.error('Error adding medication:', error);

          // Show specific error message
          const errorMsg = error.message || 'Unknown error occurred';
          if (errorMsg.includes('network') || errorMsg.includes('fetch')) {
            addMessage('ðŸŒ Network error. Please check your connection and try again.', 'bot', true);
          } else if (errorMsg.includes('timeout')) {
            addMessage('â±ï¸ Request timed out. Please try again.', 'bot', true);
          } else {
            addMessage(`âŒ ${errorMsg}. Please try again or add it manually using the Add Medication button.`, 'bot', true);
          }
        }
      }

      async function addSchedule(data) {
        console.log('ðŸ“… Adding schedule with data:', JSON.stringify(data, null, 2));
        console.log('ðŸ“ Last added medication:', lastAddedMedication);

        // If medication_id is missing, use last added medication
        if (!data.medication_id && lastAddedMedication) {
          console.log('ðŸ’¡ Using last added medication:', lastAddedMedication.name);
          data.medication_id = lastAddedMedication.id;
        }

        // Validate we have required fields
        if (!data.medication_id) {
          console.error('âŒ Validation failed: No medication_id');

          // Check if medication name was mentioned but not found in list
          const mentionedMed = data.medication_name || 'that medication';
          addMessage(`âŒ I couldn't find ${mentionedMed} in your medication list. Would you like to add it first? Just say: "Add ${mentionedMed} [dosage] [form]"`, 'bot', true);
          return;
        }

        if (!data.time) {
          console.error('âŒ Validation failed: No time');
          addMessage('âŒ I couldn\'t identify the time. Please include a time like: "at 8am" or "at 10:30"', 'bot', true);
          return;
        }

        // Validate food timing (required field)
        if (!data.food_timing || data.food_timing === '') {
          console.error('âŒ Validation failed: No food timing');
          addMessage('âŒ Food timing is required. Please specify: before food, after food, or no specific timing. Example: "Schedule at 8am before food"', 'bot', true);
          return;
        }

        console.log('âœ… Validation passed, calling API...');
        console.log('API URL:', `${CHAT_API_BASE}/schedules`);
        console.log('Request body:', JSON.stringify(data, null, 2));

        try {
          const response = await fetch(`${CHAT_API_BASE}/schedules`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          console.log('API Response status:', response.status);
          console.log('API Response ok:', response.ok);

          const responseText = await response.text();
          console.log('API Response body:', responseText);

          if (response.ok) {
            const result = JSON.parse(responseText);
            console.log('âœ… Schedule created successfully:', result);

            const medName = lastAddedMedication?.name || data.medication_name || 'Your medication';
            addMessage(`âœ… Schedule created! ${medName} is now scheduled for ${data.time} ${data.frequency}.`, 'bot');

            lastAddedMedication = null; // Clear context

            // Close chat and refresh
            setTimeout(() => {
              sidebar.style.transform = 'translateX(100%)';
              if (typeof loadSchedules === 'function') {
                loadSchedules();
              } else {
                window.location.reload();
              }
            }, 1500);
          } else {
            console.error('âŒ API returned error status:', response.status);
            const error = JSON.parse(responseText);
            console.error('Error details:', error);
            throw new Error(error.message || error.error || 'Failed to create schedule');
          }
        } catch (error) {
          console.error('âŒ Exception in addSchedule:', error);
          console.error('Error stack:', error.stack);
          addMessage(`âŒ Failed to create schedule: ${error.message}. Please try again or use the Schedule button.`, 'bot', true);
        }
      }

      async function showRefills() {
        try {
          const response = await fetch(`${CHAT_API_BASE}/medications`);
          const data = await response.json();

          const lowStock = data.medications.filter(m => {
            const remaining = m.quantity || 0;
            return remaining <= 10;
          });

          if (lowStock.length === 0) {
            addMessage('ðŸŽ‰ All medications have sufficient quantity!', 'bot');
          } else {
            let msg = 'ðŸ”” Medications that need refilling:\n\n';
            lowStock.forEach(med => {
              const qty = med.quantity || 0;
              msg += `âš ï¸ ${med.name} - Only ${qty} ${med.form || 'doses'} left\n`;
            });
            msg += '\nConsider refilling these soon!';
            addMessage(msg, 'bot');
          }
        } catch (error) {
          addMessage('Error checking refills.', 'bot', true);
        }
      }

      function extractScheduleDataManually(text) {
        if (!lastAddedMedication) return null;

        const data = {
          medication_id: lastAddedMedication.id,
          time: '',
          frequency: 'daily',
          with_food: false,
          special_instructions: '',
          start_date: new Date().toISOString().split('T')[0] // Add today's date as start_date
        };

        // Extract time with proper minute/period detection
        let timeMatch = null;
        let hour = 0;
        let minute = 0;
        let period = null;

        // Try HH:MM am/pm format
        timeMatch = text.match(/(\d{1,2}):(\d{2})\s*(am|pm)?/i);
        if (timeMatch) {
          hour = parseInt(timeMatch[1]);
          minute = parseInt(timeMatch[2]);
          period = timeMatch[3];
        } else {
          // Try H am/pm format (no minutes)
          timeMatch = text.match(/(\d{1,2})\s*(am|pm)/i);
          if (timeMatch) {
            hour = parseInt(timeMatch[1]);
            minute = 0;
            period = timeMatch[2];
          }
        }

        if (timeMatch) {
          // Convert to 24-hour format
          if (period && period.toLowerCase() === 'pm' && hour < 12) {
            hour += 12;
          } else if (period && period.toLowerCase() === 'am' && hour === 12) {
            hour = 0;
          }

          data.time = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
        }

        // Extract frequency
        const lowerText = text.toLowerCase();
        if (lowerText.includes('daily') || lowerText.includes('every day')) {
          data.frequency = 'daily';
        } else if (lowerText.includes('weekly')) {
          data.frequency = 'weekly';
        } else if (lowerText.includes('as needed')) {
          data.frequency = 'as_needed';
        }

        // Check for food requirement
        if (lowerText.includes('with food')) {
          data.with_food = true;
        }

        return data.time ? data : null;
      }

      // DELETE MEDICATION CONFIRMATION
      function showDeleteMedicationConfirmation(data) {
        if (data.multiple) {
          // Multiple matches found - show clickable buttons for each
          let msg = 'âš ï¸ I found multiple medications matching your request:\n\n';
          data.medications.forEach((med, idx) => {
            msg += `${idx + 1}. ${med.name} (${med.dosage || 'N/A'}, ${med.form || 'N/A'})\n`;
          });
          msg += '\nWhich one would you like to delete?';
          addMessage(msg, 'bot');

          // Create clickable buttons for each medication
          const buttonContainer = document.createElement('div');
          buttonContainer.style.display = 'flex';
          buttonContainer.style.flexDirection = 'column';
          buttonContainer.style.gap = '8px';
          buttonContainer.style.marginTop = '8px';
          buttonContainer.style.marginBottom = '16px';

          data.medications.forEach((med, idx) => {
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = `ðŸ—‘ï¸ Delete ${med.name} (${med.dosage || 'N/A'}, ${med.form || 'N/A'})`;
            deleteBtn.style.cssText = 'background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;';
            deleteBtn.onclick = async () => {
              buttonContainer.remove();
              // Show individual confirmation for this specific medication
              const medDetails = `${med.name} (${med.dosage || 'N/A'}, ${med.form || 'N/A'})`;
              const confirmMsg = `ðŸ—‘ï¸ Are you sure you want to delete ${medDetails}? This action cannot be undone.`;
              addMessage(confirmMsg, 'bot');

              const confirmDiv = document.createElement('div');
              confirmDiv.style.display = 'flex';
              confirmDiv.style.gap = '8px';
              confirmDiv.style.marginTop = '8px';
              confirmDiv.style.marginBottom = '16px';

              const yesBtn = document.createElement('button');
              yesBtn.textContent = 'âœ“ Yes, Delete';
              yesBtn.style.cssText = 'background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;';
              yesBtn.onclick = async () => {
                confirmDiv.remove();
                await deleteMedication(med.id, medDetails);
              };

              const noBtn = document.createElement('button');
              noBtn.textContent = 'Cancel';
              noBtn.style.cssText = 'background: #e5e7eb; color: #374151; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;';
              noBtn.onclick = () => {
                confirmDiv.remove();
                addMessage('Deletion cancelled.', 'bot');
              };

              confirmDiv.appendChild(yesBtn);
              confirmDiv.appendChild(noBtn);
              messagesDiv.appendChild(confirmDiv);
              messagesDiv.scrollTop = messagesDiv.scrollHeight;

              // Auto-confirm this specific deletion after 3s unless cancelled
              autoClick(yesBtn, confirmDiv, 3000);
            };
            buttonContainer.appendChild(deleteBtn);
          });

          // Add cancel button
          const cancelBtn = document.createElement('button');
          cancelBtn.textContent = 'Cancel';
          cancelBtn.style.cssText = 'background: #e5e7eb; color: #374151; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;';
          cancelBtn.onclick = () => {
            buttonContainer.remove();
            addMessage('Deletion cancelled.', 'bot');
          };
          buttonContainer.appendChild(cancelBtn);

          messagesDiv.appendChild(buttonContainer);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
          return;
        }

        const medName = data.medication_name || 'this medication';
        const confirmMsg = `ðŸ—‘ï¸ Are you sure you want to delete ${medName}? This action cannot be undone.`;
        addMessage(confirmMsg, 'bot');

        const buttonDiv = document.createElement('div');
        buttonDiv.style.display = 'flex';
        buttonDiv.style.gap = '8px';
        buttonDiv.style.marginTop = '8px';
        buttonDiv.style.marginBottom = '16px';

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'ðŸ—‘ï¸ Yes, Delete';
        deleteBtn.style.cssText = 'background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;';
        deleteBtn.onclick = async () => {
          buttonDiv.remove();
          await deleteMedication(data.medication_id, medName);
        };

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Cancel';
        cancelBtn.style.cssText = 'background: #e5e7eb; color: #374151; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;';
        cancelBtn.onclick = () => {
          buttonDiv.remove();
          addMessage('Deletion cancelled. Your medication is safe!', 'bot');
        };

        buttonDiv.appendChild(deleteBtn);
        buttonDiv.appendChild(cancelBtn);
        messagesDiv.appendChild(buttonDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // Auto-execute deletion after 3s unless cancelled
        autoClick(deleteBtn, buttonDiv, 3000);
      }

      async function deleteMedication(medicationId, medicationName) {
        try {
          const response = await fetch(`${CHAT_API_BASE}/medications/${medicationId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
          });

          if (response.ok) {
            addMessage(`âœ… ${medicationName} has been deleted from your medications.`, 'bot');
            setTimeout(() => {
              if (typeof loadMedications === 'function') {
                loadMedications();
              } else {
                window.location.reload();
              }
            }, 1500);
          } else {
            throw new Error('Failed to delete medication');
          }
        } catch (error) {
          console.error('Error deleting medication:', error);
          addMessage('âŒ Failed to delete medication. Please try again.', 'bot', true);
        }
      }

      // DELETE ALL MEDICATIONS CONFIRMATION
      function showDeleteAllMedicationsConfirmation(data) {
        const medications = data.medications || [];

        if (medications.length === 0) {
          addMessage('â„¹ï¸ Your medication list is already empty.', 'bot');
          return;
        }

        let msg = `âš ï¸ I'll delete all ${medications.length} medications. Are you sure?\n\nThis will remove:\n`;
        medications.forEach(med => {
          msg += `â€¢ ${med.name} (${med.dosage || 'N/A'}, ${med.form || 'N/A'})\n`;
        });
        msg += '\nThis action cannot be undone!';

        addMessage(msg, 'bot');

        const buttonDiv = document.createElement('div');
        buttonDiv.style.display = 'flex';
        buttonDiv.style.gap = '8px';
        buttonDiv.style.marginTop = '8px';
        buttonDiv.style.marginBottom = '16px';

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'ðŸ—‘ï¸ Yes, Delete All';
        deleteBtn.style.cssText = 'background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;';
        deleteBtn.onclick = async () => {
          buttonDiv.remove();
          await deleteAllMedications(medications);
        };

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Cancel';
        cancelBtn.style.cssText = 'background: #e5e7eb; color: #374151; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;';
        cancelBtn.onclick = () => {
          buttonDiv.remove();
          addMessage('Deletion cancelled. Your medications are safe!', 'bot');
        };

        buttonDiv.appendChild(deleteBtn);
        buttonDiv.appendChild(cancelBtn);
        messagesDiv.appendChild(buttonDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // Auto-execute schedule deletion after 3s unless cancelled
        autoClick(deleteBtn, buttonDiv, 3000);
      }

      async function deleteAllMedications(medications) {
        try {
          addMessage(`ðŸ—‘ï¸ Deleting ${medications.length} medications...`, 'bot');

          let successCount = 0;
          let failCount = 0;

          // Delete each medication sequentially
          for (const med of medications) {
            try {
              const response = await fetch(`${CHAT_API_BASE}/medications/${med.id}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
              });

              if (response.ok) {
                successCount++;
              } else {
                failCount++;
              }
            } catch (err) {
              console.error(`Failed to delete ${med.name}:`, err);
              failCount++;
            }
          }

          if (successCount === medications.length) {
            addMessage(`âœ… All ${successCount} medications have been deleted from your list.`, 'bot');
          } else if (successCount > 0) {
            addMessage(`âš ï¸ Deleted ${successCount} medications, but ${failCount} failed. Please refresh and try again for the remaining ones.`, 'bot');
          } else {
            addMessage(`âŒ Failed to delete medications. Please try again.`, 'bot', true);
          }

          // Refresh the medications list
          setTimeout(() => {
            if (typeof loadMedications === 'function') {
              loadMedications();
            } else {
              window.location.reload();
            }
          }, 1500);

        } catch (error) {
          console.error('Error deleting all medications:', error);
          addMessage('âŒ Failed to delete medications. Please try again.', 'bot', true);
        }
      }

      // DELETE SCHEDULE CONFIRMATION
      function showDeleteScheduleConfirmation(data) {
        const medName = data.medication_name || 'this medication';
        const confirmMsg = `ðŸ—‘ï¸ Are you sure you want to delete the schedule for ${medName}?`;
        addMessage(confirmMsg, 'bot');

        const buttonDiv = document.createElement('div');
        buttonDiv.style.display = 'flex';
        buttonDiv.style.gap = '8px';
        buttonDiv.style.marginTop = '8px';
        buttonDiv.style.marginBottom = '16px';

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'ðŸ—‘ï¸ Yes, Delete Schedule';
        deleteBtn.style.cssText = 'background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;';
        deleteBtn.onclick = async () => {
          buttonDiv.remove();
          await deleteSchedule(data.medication_id, medName);
        };

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Cancel';
        cancelBtn.style.cssText = 'background: #e5e7eb; color: #374151; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;';
        cancelBtn.onclick = () => {
          buttonDiv.remove();
          addMessage('Deletion cancelled.', 'bot');
        };

        buttonDiv.appendChild(deleteBtn);
        buttonDiv.appendChild(cancelBtn);
        messagesDiv.appendChild(buttonDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      async function deleteSchedule(medicationId, medicationName) {
        try {
          // Get schedules for this medication
          const response = await fetch(`${API_BASE}/schedules?medication_id=${medicationId}`);
          const data = await response.json();

          if (data.schedules && data.schedules.length > 0) {
            // Delete all schedules for this medication
            for (const schedule of data.schedules) {
              await fetch(`${CHAT_API_BASE}/schedules/${schedule.id}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
              });
            }

            addMessage(`âœ… Schedule for ${medicationName} has been deleted.`, 'bot');
            setTimeout(() => {
              if (typeof loadSchedules === 'function') {
                loadSchedules();
              } else {
                window.location.reload();
              }
            }, 1500);
          } else {
            addMessage(`âš ï¸ No schedule found for ${medicationName}.`, 'bot');
          }
        } catch (error) {
          console.error('Error deleting schedule:', error);
          addMessage('âŒ Failed to delete schedule. Please try again.', 'bot', true);
        }
      }

      // UPDATE MEDICATION PREVIEW
      function showUpdateMedicationPreview(data) {
        const medName = data.medication_name || 'medication';
        const updates = data.updates || {};

        let updateMsg = `âœï¸ I'll update ${medName} with the following changes:\n\n`;

        if (updates.dosage) updateMsg += `â€¢ Dosage: ${updates.dosage}\n`;
        if (updates.total_quantity) updateMsg += `â€¢ Quantity: ${updates.total_quantity} units\n`;
        if (updates.form) updateMsg += `â€¢ Form: ${updates.form}\n`;
        if (updates.purpose) updateMsg += `â€¢ Purpose: ${updates.purpose}\n`;

        updateMsg += '\nIs this correct?';

        addMessage(updateMsg, 'bot');

        const buttonDiv = document.createElement('div');
        buttonDiv.style.display = 'flex';
        buttonDiv.style.gap = '8px';
        buttonDiv.style.marginTop = '8px';
        buttonDiv.style.marginBottom = '16px';

        const updateBtn = document.createElement('button');
        updateBtn.textContent = 'âœ… Update';
        updateBtn.style.cssText = 'background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;';
        updateBtn.onclick = async () => {
          buttonDiv.remove();
          await updateMedication(data.medication_id, updates, medName);
        };

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Cancel';
        cancelBtn.style.cssText = 'background: #e5e7eb; color: #374151; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;';
        cancelBtn.onclick = () => {
          buttonDiv.remove();
          addMessage('Update cancelled.', 'bot');
        };

        buttonDiv.appendChild(updateBtn);
        buttonDiv.appendChild(cancelBtn);
        messagesDiv.appendChild(buttonDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // Auto-execute update after 3s unless cancelled
        autoClick(updateBtn, buttonDiv, 3000);
      }

      async function updateMedication(medicationId, updates, medicationName) {
        try {
          const response = await fetch(`${CHAT_API_BASE}/medications/${medicationId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updates)
          });

          if (response.ok) {
            addMessage(`âœ… ${medicationName} has been updated successfully!`, 'bot');
            setTimeout(() => {
              if (typeof loadMedications === 'function') {
                loadMedications();
              } else {
                window.location.reload();
              }
            }, 1500);
          } else {
            throw new Error('Failed to update medication');
          }
        } catch (error) {
          console.error('Error updating medication:', error);
          addMessage('âŒ Failed to update medication. Please try again.', 'bot', true);
        }
      }

      // UPDATE SCHEDULE PREVIEW
      function showUpdateSchedulePreview(data) {
        const medName = data.medication_name || 'medication';
        const updates = data.updates || {};

        let updateMsg = `âœï¸ I'll update the schedule for ${medName}:\n\n`;

        if (updates.time) updateMsg += `â€¢ Time: ${updates.time}\n`;
        if (updates.frequency) updateMsg += `â€¢ Frequency: ${updates.frequency}\n`;
        if (updates.food_timing) {
          const foodText = updates.food_timing === 'before_food' ? 'Before food' :
            updates.food_timing === 'after_food' ? 'After food' :
              'No specific timing';
          updateMsg += `â€¢ Food timing: ${foodText}\n`;
        }

        updateMsg += '\nIs this correct?';

        addMessage(updateMsg, 'bot');

        const buttonDiv = document.createElement('div');
        buttonDiv.style.display = 'flex';
        buttonDiv.style.gap = '8px';
        buttonDiv.style.marginTop = '8px';
        buttonDiv.style.marginBottom = '16px';

        const updateBtn = document.createElement('button');
        updateBtn.textContent = 'âœ… Update Schedule';
        updateBtn.style.cssText = 'background: linear-gradient(135deg, #7c3aed 0%, #2563eb 100%); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;';
        updateBtn.onclick = async () => {
          buttonDiv.remove();
          await updateSchedule(data.medication_id, updates, medName);
        };

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Cancel';
        cancelBtn.style.cssText = 'background: #e5e7eb; color: #374151; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;';
        cancelBtn.onclick = () => {
          buttonDiv.remove();
          addMessage('Update cancelled.', 'bot');
        };

        buttonDiv.appendChild(updateBtn);
        buttonDiv.appendChild(cancelBtn);
        messagesDiv.appendChild(buttonDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      async function updateSchedule(medicationId, updates, medicationName) {
        try {
          // Get schedules for this medication
          const response = await fetch(`${API_BASE}/schedules?medication_id=${medicationId}`);
          const data = await response.json();

          if (data.schedules && data.schedules.length > 0) {
            // Update the first schedule (or all if needed)
            const schedule = data.schedules[0];

            const updateResponse = await fetch(`${CHAT_API_BASE}/schedules/${schedule.id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(updates)
            });

            if (updateResponse.ok) {
              addMessage(`âœ… Schedule for ${medicationName} has been updated!`, 'bot');
              setTimeout(() => {
                if (typeof loadSchedules === 'function') {
                  loadSchedules();
                } else {
                  window.location.reload();
                }
              }, 1500);
            } else {
              throw new Error('Failed to update schedule');
            }
          } else {
            addMessage(`âš ï¸ No schedule found for ${medicationName}. Would you like to create one?`, 'bot');
          }
        } catch (error) {
          console.error('Error updating schedule:', error);
          addMessage('âŒ Failed to update schedule. Please try again.', 'bot', true);
        }
      }

      console.log('âœ… AI Chatbot ready! Button visible at bottom-right.');
    })();
  </script>

  <style>
    @keyframes bounce {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-4px);
      }
    }
    .animated-gradient-text {
      background-size: 200% 200%;
      animation: gradientShift 6s ease infinite;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
  </style>

  <!-- PWA Service Worker Registration - TEMPORARILY DISABLED -->
  <script>
    // Temporarily disabled to fix caching issues
    console.log('âš ï¸ Service Worker disabled for debugging');

    // Clear any existing service workers
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(registrations => {
        registrations.forEach(reg => {
          reg.unregister();
          console.log('ðŸ§¹ Unregistered service worker:', reg.scope);
        });
      });
    }
  </script>

  <!-- PWA Install Prompt -->
  <script>
    // Install prompt for PWA
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      console.log('ðŸ’¡ App can be installed!');

      // Show install button after 3 seconds
      setTimeout(() => {
        if (confirm('ðŸ“± Install Medication Manager as an app on your device?')) {
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
              console.log('âœ… User accepted the install prompt');
            }
            deferredPrompt = null;
          });
        }
      }, 3000);
    });
  </script>

  <!-- Bottom Navigation for Mobile -->
  <nav class="bottom-nav">
    <button onclick="showTab('medications')" data-tab="medications">
      <i class="fas fa-pills"></i>
      <span>My Meds</span>
    </button>
    <button onclick="showTab('dashboard')" data-tab="dashboard" class="active">
      <i class="fas fa-home"></i>
      <span>Today</span>
    </button>
    <button onclick="showTab('history')" data-tab="history">
      <i class="fas fa-history"></i>
      <span>History</span>
    </button>
  </nav>

  <!-- Text Size & Accessibility Controls (Floating) -->
  <div id="accessibility-controls" style="position: fixed; top: 80px; right: 16px; z-index: 999; display: none;">
    <div style="background: white; padding: 16px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
      <h3 style="font-size: 18px; margin-bottom: 12px;">Text Size</h3>
      <div class="text-size-controls">
        <button onclick="setTextSize('small')" title="Small text">A</button>
        <button onclick="setTextSize('medium')" class="active" title="Medium text">A</button>
        <button onclick="setTextSize('large')" title="Large text">A</button>
      </div>

      <h3 style="font-size: 18px; margin: 16px 0 12px 0;">Theme</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
        <button onclick="setTheme('light')" class="theme-btn" data-theme="light"
          style="padding: 8px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: black;">Light</button>
        <button onclick="setTheme('dark')" class="theme-btn" data-theme="dark"
          style="padding: 8px; border: 2px solid #374151; border-radius: 8px; background: #1f2937; color: white;">Dark</button>
        <button onclick="setTheme('calm')" class="theme-btn" data-theme="calm"
          style="padding: 8px; border: 2px solid #bfdbfe; border-radius: 8px; background: #f0f9ff; color: #1e3a8a;">Blue</button>
      </div>
    </div>
  </div>

  <!-- Accessibility Toggle Button -->
  <button onclick="toggleAccessibilityControls()"
    style="position: fixed; top: 80px; right: 16px; z-index: 1000; min-width: 48px; min-height: 48px; border-radius: 50%; background: white; border: 2px solid #e5e7eb; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
    title="Accessibility options">
    <i class="fas fa-universal-access" style="font-size: 24px; color: #7c3aed;"></i>
  </button>

  <script>
    function toggleAccessibilityControls() {
      const controls = document.getElementById('accessibility-controls');
      controls.style.display = controls.style.display === 'none' ? 'block' : 'none';
    }

    // Update bottom nav active state
    function updateBottomNav(tabName) {
      document.querySelectorAll('.bottom-nav button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.tab === tabName) {
          btn.classList.add('active');
        }
      });
    }

    // Override showTab to update bottom nav
    const originalShowTab = window.showTab;
    window.showTab = function (tabName) {
      if (originalShowTab) originalShowTab(tabName);
      updateBottomNav(tabName);
    };
  </script>

  <!-- Senior-Friendly Features Script -->
  <script src="/scripts/senior-friendly.js"></script>

  <!-- Medication Wizard (Simplified 3-Step Form) -->
  <script src="/scripts/medication-wizard.js"></script>

  <!-- Quick Actions (One-Tap Buttons) -->
  <script src="/scripts/quick-actions.js"></script>

  <!-- Hammer.js for Touch Gestures (Free CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>

  <!-- QR Code Generator for Emergency Info (Free CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js">  </script>

  <!-- Settings Modal -->
  <div id="settings-modal" class="modal">
    <div class="modal-content bg-white w-full mx-4 rounded-2xl shadow-xl p-6" style="max-width: 500px">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Settings</h2>
        <button onclick="closeSettings()" class="text-gray-500 hover:text-gray-700" aria-label="Close settings">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>

      <div id="settings-content">
        <!-- Text Size Only -->
        <div class="mb-6">
          <label class="block text-sm font-semibold text-gray-700 mb-3">Text Size</label>
          <div class="flex space-x-2">
            <button onclick="setTextSize('small')"
              class="flex-1 py-3 border rounded-lg hover:bg-gray-50 font-medium text-sm">A</button>
            <button onclick="setTextSize('medium')"
              class="flex-1 py-3 border rounded-lg hover:bg-gray-50 font-bold text-base bg-blue-50 border-blue-200 text-blue-700">A</button>
            <button onclick="setTextSize('large')"
              class="flex-1 py-3 border rounded-lg hover:bg-gray-50 font-extrabold text-xl">A</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation (Fixed & Permanent) -->
  <nav class="bottom-nav">
    <button class="bottom-nav-item active" onclick="showTab('dashboard')" aria-label="Dashboard">
      <i class="fas fa-home"></i>
      <span>Home</span>
    </button>
    <button class="bottom-nav-item inactive" onclick="showTab('medications')" aria-label="Medications">
      <i class="fas fa-pills"></i>
      <span>Meds</span>
    </button>

    <!-- AI Chatbot Button (Center Docked) -->
    <button class="bottom-nav-item ai-dock-btn" onclick="toggleChat()" aria-label="AI Assistant">
      <div class="ai-icon-container">
        <i class="fas fa-robot"></i>
      </div>
      <span>Assistant</span>
    </button>

    <button class="bottom-nav-item inactive" onclick="showTab('schedules')" aria-label="Schedule">
      <i class="fas fa-calendar-alt"></i>
      <span>Schedule</span>
    </button>
    <button class="bottom-nav-item inactive" onclick="showTab('history')" aria-label="History">
      <i class="fas fa-history"></i>
      <span>History</span>
    </button>
  </nav>

  <!-- Load Settings Script -->
  <script src="settings.js"></script>
  <script src="app.js"></script>

  <!-- Global Chatbot Handlers -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('ðŸš€ App initialized. Setting up global handlers...');

      // 1. Swipe Gestures for Chatbot
      let touchStartX = 0;
      let touchEndX = 0;

      document.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
      }, { passive: true });

      document.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
      }, { passive: true });

      function handleSwipe() {
        const swipeThreshold = 100; // Minimum distance for swipe
        const sidebar = document.getElementById('ai-chat-sidebar');
        if (!sidebar) return;

        const isOpen = sidebar.style.transform === 'translateX(0%)';

        // Right Swipe (Dismiss)
        if (touchEndX - touchStartX > swipeThreshold && isOpen) {
          console.log('ðŸ‘‰ Right swipe detected: Closing chat');
          toggleChat();
        }

        // Left Swipe (Open)
        if (touchStartX - touchEndX > swipeThreshold && !isOpen) {
          console.log('ðŸ‘ˆ Left swipe detected: Opening chat');
          toggleChat();
        }
      }

      // 2. Expose handleAction Globally
      // This function delegates to the app.js functions which should be global or attached to window
      window.handleAction = async function (action) {
        console.log('ðŸ”§ Global handleAction called:', action);

        // Ensure the modal functions exist
        if (typeof window.showMedicationPreview === 'function' && action.type === 'add_medication') {
          window.showMedicationPreview(action.data);
        } else if (typeof window.showSchedulePreview === 'function' && action.type === 'add_schedule') {
          window.showSchedulePreview(action.data);
        } else if (typeof window.showCombinedPreview === 'function' && action.type === 'add_medication_and_schedule') {
          window.showCombinedPreview(action.data);
        } else if (action.type === 'show_schedule') {
          if (typeof window.showTodaySchedule === 'function') window.showTodaySchedule();
          else console.warn('showTodaySchedule not found');
        } else if (action.type === 'show_stats') {
          if (typeof window.showStats === 'function') window.showStats();
          else console.warn('showStats not found');
        } else {
          console.warn('âš ï¸ Unknown action or missing handler:', action.type);
          // Fallback: Try to find functions in the global scope if they aren't explicitly on window
          try {
            if (action.type === 'add_medication') showMedicationPreview(action.data);
            if (action.type === 'add_schedule') showSchedulePreview(action.data);
          } catch (e) {
            console.error('âŒ Fallback execution failed:', e);
            addMessage('I tried to open the form, but something went wrong. Please try the manual "Add" button.', 'bot', true);
          }
        }
      };

      // 3. Chatbot Logic
      window.sendMessage = async function () {
        const input = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');

        if (!input || !sendBtn) return;

        const message = input.value.trim();
        if (!message) return;

        // Disable UI
        input.value = '';
        input.disabled = true;
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        // Add User Message
        addMessage(message, 'user');

        // Typing Indicator
        const typingId = addTypingIndicator();

        try {
          // Use the increased timeout from server, but also set a client-side timeout
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 35000); // 35s client timeout

          const response = await fetch(`${CHAT_API_BASE}/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message,
              history: (window.chatHistory || []).slice(-10)
            }),
            signal: controller.signal
          });

          clearTimeout(timeoutId);
          removeTypingIndicator(typingId);

          if (response.ok) {
            const data = await response.json();
            addMessage(data.response, 'bot');

            if (!window.chatHistory) window.chatHistory = [];
            window.chatHistory.push(
              { role: 'user', content: message },
              { role: 'assistant', content: data.response }
            );

            if (data.action) {
              console.log('ðŸŽ¯ Action detected:', data.action);
              await window.handleAction(data.action);
            }
          } else {
            throw new Error('Server response not ok');
          }
        } catch (error) {
          console.error('âŒ Chat error:', error);
          removeTypingIndicator(typingId);
          let errorMsg = 'Sorry, something went wrong.';
          if (error.name === 'AbortError') errorMsg = 'Request timed out. Please try again.';
          addMessage(errorMsg, 'bot', true);
        } finally {
          // Re-enable UI
          input.disabled = false;
          sendBtn.disabled = false;
          sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
          input.focus();
        }
      };

      // Helper: Add Message
      window.addMessage = function (text, sender, isError = false) {
        const messagesDiv = document.getElementById('ai-chat-messages');
        if (!messagesDiv) return;

        const div = document.createElement('div');
        div.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} mb-4`;

        const bubble = document.createElement('div');
        bubble.className = `max-w-[85%] p-3 rounded-2xl text-[15px] leading-relaxed shadow-sm ${sender === 'user'
            ? 'bg-blue-700 text-white rounded-br-sm'
            : isError
              ? 'bg-red-50 text-red-800 border border-red-100 rounded-bl-sm'
              : 'bg-white text-slate-900 border border-slate-200 rounded-bl-sm'
          }`;
        bubble.textContent = text;

        div.appendChild(bubble);
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        return div;
      };

      // Helper: Typing Indicator
      window.addTypingIndicator = function () {
        const messagesDiv = document.getElementById('ai-chat-messages');
        if (!messagesDiv) return null;

        const id = 'typing-' + Date.now();
        const div = document.createElement('div');
        div.id = id;
        div.className = 'flex justify-start mb-4';
        div.innerHTML = `
          <div class="bg-slate-100 p-3 rounded-2xl rounded-bl-sm flex space-x-1">
            <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0s"></div>
            <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
          </div>
        `;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        return id;
      };

      // Helper: Remove Typing Indicator
      window.removeTypingIndicator = function (id) {
        const el = document.getElementById(id);
        if (el) el.remove();
      };

      // Text Size Handler
      window.setTextSize = function (size) {
        const root = document.documentElement;
        if (size === 'small') root.style.setProperty('--text-size', '13px');
        if (size === 'medium') root.style.setProperty('--text-size', '15px');
        if (size === 'large') root.style.setProperty('--text-size', '18px');

        // Highlight active button
        document.querySelectorAll('#settings-modal button[onclick^="setTextSize"]').forEach((btn) => {
          btn.classList.remove('bg-blue-50','border-blue-200','text-blue-700');
        });
        const idx = size === 'small' ? 0 : (size === 'medium' ? 1 : 2);
        const activeBtn = document.querySelectorAll('#settings-modal button[onclick^="setTextSize"]')[idx];
        if (activeBtn) activeBtn.classList.add('bg-blue-50','border-blue-200','text-blue-700');

        localStorage.setItem('med-manager-text-size', size);
      };

      // Apply saved preference on load
      const savedSize = localStorage.getItem('med-manager-text-size') || 'medium';
      setTextSize(savedSize);

      // Attach Event Listeners
      const sendBtn = document.getElementById('send-btn');
      const chatInput = document.getElementById('chat-input');

      if (sendBtn) {
        sendBtn.onclick = (e) => {
          e.preventDefault();
          window.sendMessage();
        };
      }

      if (chatInput) {
        chatInput.onkeypress = (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            window.sendMessage();
          }
        };
      }

      // Quick Action Buttons
      document.querySelectorAll('.quick-btn').forEach(btn => {
        btn.onclick = (e) => {
          e.preventDefault();
          const action = e.currentTarget.dataset.action;
          const input = document.getElementById('chat-input');
          if (!input) return;

          let msg = '';
          if (action === 'today') msg = 'What medications do I need to take today?';
          if (action === 'add') msg = 'I want to add a new medication';
          if (action === 'stats') msg = 'Show me my adherence stats';

          if (msg) {
            input.value = msg;
            window.sendMessage();
          }
        };
      });
    });
  </script>

</body>

</html>